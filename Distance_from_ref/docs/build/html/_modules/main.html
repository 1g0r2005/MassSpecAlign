

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>main &mdash; Assessment of the quality of MSI data alignment  documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Assessment of the quality of MSI data alignment
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Documentation sections:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../modules.html">src</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data_classes.html">data classes module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../main.html">main module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../alignment.html">alignment module</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Assessment of the quality of MSI data alignment</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
      <li class="breadcrumb-item active">main</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for main</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>

<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PYQTGRAPH_QT_LIB&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;PyQt5&#39;</span>

<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span><span class="p">,</span> <span class="n">Queue</span><span class="p">,</span> <span class="n">Pool</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">queue</span> <span class="kn">import</span> <span class="n">Empty</span>
<span class="kn">import</span> <span class="nn">traceback</span>

<span class="kn">import</span> <span class="nn">h5py</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pyqtgraph</span> <span class="k">as</span> <span class="nn">pg</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span> <span class="k">as</span> <span class="nn">stats</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">from</span> <span class="nn">IPython.external.qt_for_kernel</span> <span class="kn">import</span> <span class="n">QtCore</span>
<span class="kn">from</span> <span class="nn">KDEpy</span> <span class="kn">import</span> <span class="n">FFTKDE</span>
<span class="kn">from</span> <span class="nn">PyQt5</span> <span class="kn">import</span> <span class="n">QtWidgets</span>
<span class="kn">from</span> <span class="nn">PyQt5.QtCore</span> <span class="kn">import</span> <span class="n">QTimer</span><span class="p">,</span> <span class="n">QObject</span><span class="p">,</span> <span class="n">pyqtSignal</span><span class="p">,</span> <span class="n">Qt</span><span class="p">,</span> <span class="n">QThread</span>
<span class="kn">from</span> <span class="nn">PyQt5.QtGui</span> <span class="kn">import</span> <span class="n">QIcon</span>
<span class="kn">from</span> <span class="nn">PyQt5.QtWidgets</span> <span class="kn">import</span> <span class="n">QMainWindow</span><span class="p">,</span> <span class="n">QApplication</span><span class="p">,</span> <span class="n">QWidget</span><span class="p">,</span> <span class="n">QLineEdit</span><span class="p">,</span> <span class="n">QLabel</span><span class="p">,</span> <span class="n">QPushButton</span><span class="p">,</span> \
    <span class="n">QFormLayout</span><span class="p">,</span> <span class="n">QFileDialog</span><span class="p">,</span> <span class="n">QTableWidgetItem</span><span class="p">,</span> <span class="n">QTableWidget</span><span class="p">,</span> <span class="n">QVBoxLayout</span><span class="p">,</span> <span class="n">QHeaderView</span><span class="p">,</span> <span class="n">QAbstractItemView</span><span class="p">,</span> <span class="n">QSplitter</span><span class="p">,</span> \
    <span class="n">QHBoxLayout</span><span class="p">,</span> <span class="n">QTreeWidget</span><span class="p">,</span> <span class="n">QTreeWidgetItem</span><span class="p">,</span> <span class="n">QProgressBar</span>
<span class="kn">from</span> <span class="nn">diptest</span> <span class="kn">import</span> <span class="n">diptest</span>
<span class="kn">from</span> <span class="nn">numba</span> <span class="kn">import</span> <span class="n">jit</span>

<span class="kn">import</span> <span class="nn">alignment</span>
<span class="kn">from</span> <span class="nn">data_classes</span> <span class="kn">import</span> <span class="o">*</span>

<span class="sd">&quot;&quot;&quot;classes declaration&quot;&quot;&quot;</span>


<div class="viewcode-block" id="Const">
<a class="viewcode-back" href="../main.html#main.Const">[docs]</a>
<span class="k">class</span> <span class="nc">Const</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Container for application-wide constants.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    DATASET_RAW : str or None</span>
<span class="sd">        HDF5 path to the raw spectra dataset.</span>
<span class="sd">    DATASET_ALN : str or None</span>
<span class="sd">        HDF5 path to the aligned spectra dataset.</span>
<span class="sd">    REF : float or None</span>
<span class="sd">        Reference m/z value used to locate the reference peak.</span>
<span class="sd">    DEV : float or None</span>
<span class="sd">        Acceptable deviation (±) around `REF` when searching for the reference peak.</span>
<span class="sd">    N_DOTS : int or None</span>
<span class="sd">        Number of points for KDE evaluation.</span>
<span class="sd">    BW : float or None</span>
<span class="sd">        Bandwidth parameter for KDE.</span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="c1">#class attr</span>
    <span class="n">DATASET_RAW</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="o">=</span> <span class="kc">None</span>
    <span class="n">DATASET_ALN</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">REF</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">DEV</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">N_DOTS</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">BW</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="WorkerSignals">
<a class="viewcode-back" href="../main.html#main.WorkerSignals">[docs]</a>
<span class="k">class</span> <span class="nc">WorkerSignals</span><span class="p">(</span><span class="n">QObject</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Signals and processing pipeline for background computations.</span>

<span class="sd">    Signals</span>
<span class="sd">    -------</span>
<span class="sd">    output : pyqtSignal(str)</span>
<span class="sd">        Emitted for redirected standard output messages.</span>
<span class="sd">    error : pyqtSignal(str)</span>
<span class="sd">        Emitted for redirected standard error messages or exceptions.</span>
<span class="sd">    result : pyqtSignal(object)</span>
<span class="sd">        Emitted with computation results to be consumed by the main thread.</span>
<span class="sd">    finished : pyqtSignal()</span>
<span class="sd">        Emitted when the processing pipeline finishes.</span>
<span class="sd">    progress : pyqtSignal(int)</span>
<span class="sd">        Emitted to update a progress bar.</span>
<span class="sd">    create_pbar : pyqtSignal(tuple)</span>
<span class="sd">        Emitted to initialize a progress bar. Expected tuple is (min, max).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">error</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">object</span><span class="p">)</span>
    <span class="n">finished</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">()</span>
    <span class="n">progress</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">create_pbar</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">tuple</span><span class="p">)</span>

<div class="viewcode-block" id="WorkerSignals.find_dots_process">
<a class="viewcode-back" href="../main.html#main.WorkerSignals.find_dots_process">[docs]</a>
    <span class="k">def</span> <span class="nf">find_dots_process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the main data processing pipeline.</span>

<span class="sd">        The pipeline reads raw and aligned spectra from HDF5, computes KDEs,</span>
<span class="sd">        performs peak picking, applies criteria, aligns peak lists, and computes</span>
<span class="sd">        descriptive and inferential statistics. Results are emitted via the</span>
<span class="sd">        `result` signal as a tuple of render instructions and statistics.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Emits</span>
<span class="sd">            - ``create_pbar``: tuple of (min, max) for a progress bar.</span>
<span class="sd">            - ``progress``: updates during dataset iteration.</span>
<span class="sd">            - ``result``: composite payload for UI updates.</span>
<span class="sd">            - ``finished``: upon completion or on handled exception.</span>
<span class="sd">            - ``error``: formatted traceback on exception.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="n">features_raw</span><span class="p">,</span> <span class="n">attrs_raw</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">Const</span><span class="o">.</span><span class="n">RAW</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">Const</span><span class="o">.</span><span class="n">DATASET_RAW</span><span class="p">)</span>
            <span class="n">features_aln</span><span class="p">,</span> <span class="n">attrs_aln</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">Const</span><span class="o">.</span><span class="n">ALN</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">Const</span><span class="o">.</span><span class="n">DATASET_ALN</span><span class="p">)</span>

            <span class="c1"># включаем параллельную обработку по умолчанию (все ядра минус одно)</span>
            <span class="n">processes</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">min</span><span class="p">((</span><span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="ow">or</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
            <span class="n">distance_list</span> <span class="o">=</span> <span class="n">read_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">features_raw</span><span class="p">,</span> <span class="n">attrs_raw</span><span class="p">,</span> <span class="n">features_aln</span><span class="p">,</span> <span class="n">attrs_aln</span><span class="p">,</span> <span class="n">Const</span><span class="o">.</span><span class="n">REF</span><span class="p">,</span> <span class="n">Const</span><span class="o">.</span><span class="n">DEV</span><span class="p">,</span> <span class="n">processes</span><span class="o">=</span><span class="n">processes</span><span class="p">)</span>

            <span class="n">distance_list_prepared</span> <span class="o">=</span> <span class="n">prepare_array</span><span class="p">(</span><span class="n">distance_list</span><span class="p">)</span>
            <span class="n">raw_concat</span><span class="p">,</span> <span class="n">aln_concat</span><span class="p">,</span> <span class="n">id_concat</span> <span class="o">=</span> <span class="n">distance_list_prepared</span>

            <span class="n">kde_x_raw</span><span class="p">,</span> <span class="n">kde_y_raw</span> <span class="o">=</span> <span class="n">FFTKDE</span><span class="p">(</span><span class="n">bw</span><span class="o">=</span><span class="n">Const</span><span class="o">.</span><span class="n">BW</span><span class="p">,</span> <span class="n">kernel</span><span class="o">=</span><span class="s1">&#39;gaussian&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">raw_concat</span><span class="p">)</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">Const</span><span class="o">.</span><span class="n">N_DOTS</span><span class="p">)</span>
            <span class="n">kde_x_aln</span><span class="p">,</span> <span class="n">kde_y_aln</span> <span class="o">=</span> <span class="n">FFTKDE</span><span class="p">(</span><span class="n">bw</span><span class="o">=</span><span class="n">Const</span><span class="o">.</span><span class="n">BW</span><span class="p">,</span> <span class="n">kernel</span><span class="o">=</span><span class="s1">&#39;gaussian&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">aln_concat</span><span class="p">)</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">Const</span><span class="o">.</span><span class="n">N_DOTS</span><span class="p">)</span>


            <span class="n">center_r</span><span class="p">,</span> <span class="n">left_r</span><span class="p">,</span> <span class="n">right_r</span> <span class="o">=</span> <span class="n">peak_picking</span><span class="p">(</span><span class="n">kde_x_raw</span><span class="p">,</span> <span class="n">kde_y_raw</span><span class="p">)</span>
            <span class="n">center_a</span><span class="p">,</span> <span class="n">left_a</span><span class="p">,</span> <span class="n">right_a</span> <span class="o">=</span> <span class="n">peak_picking</span><span class="p">(</span><span class="n">kde_x_aln</span><span class="p">,</span> <span class="n">kde_y_aln</span><span class="p">)</span>
            <span class="c1"># восстановим высоту пиков</span>
            <span class="n">max_center_r</span><span class="p">,</span> <span class="n">max_center_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">center_r</span><span class="p">,</span> <span class="n">kde_x_raw</span><span class="p">,</span> <span class="n">kde_y_raw</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">center_a</span><span class="p">,</span> <span class="n">kde_x_aln</span><span class="p">,</span>
                                                                                            <span class="n">kde_y_aln</span><span class="p">)</span>

            <span class="n">borders_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">left_r</span><span class="p">,</span> <span class="n">right_r</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">borders_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">left_a</span><span class="p">,</span> <span class="n">right_a</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ds_raw</span> <span class="o">=</span> <span class="n">LinkedList</span><span class="p">(</span><span class="n">center_r</span><span class="p">,</span> <span class="n">borders_r</span><span class="p">)</span><span class="c1">#.sync_delete(np.where(max_center_r &lt;= epsilon)[0])</span>
            <span class="n">ds_aln</span> <span class="o">=</span> <span class="n">LinkedList</span><span class="p">(</span><span class="n">center_a</span><span class="p">,</span> <span class="n">borders_a</span><span class="p">)</span><span class="c1">#.sync_delete(np.where(max_center_a &lt;= epsilon)[0])</span>

            <span class="n">c_ds_raw</span><span class="p">,</span><span class="n">c_ds_aln</span> <span class="o">=</span> <span class="n">criteria_apply</span><span class="p">(</span><span class="n">ds_raw</span><span class="p">,</span> <span class="n">max_center_r</span><span class="p">),</span><span class="n">criteria_apply</span><span class="p">(</span><span class="n">ds_aln</span><span class="p">,</span> <span class="n">max_center_a</span><span class="p">)</span>
            <span class="n">c_ds_raw_intensity</span><span class="p">,</span> <span class="n">c_ds_aln_intensity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">c_ds_raw</span><span class="p">,</span> <span class="n">kde_x_raw</span><span class="p">,</span> <span class="n">kde_y_raw</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">c_ds_aln</span><span class="p">,</span> <span class="n">kde_x_aln</span><span class="p">,</span>
                                                                                                    <span class="n">kde_y_aln</span><span class="p">)</span>

            <span class="n">peak_lists_raw</span> <span class="o">=</span> <span class="n">sort_dots</span><span class="p">(</span><span class="n">raw_concat</span><span class="p">,</span> <span class="n">c_ds_raw</span><span class="o">.</span><span class="n">linked_array</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">c_ds_raw</span><span class="o">.</span><span class="n">linked_array</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">peak_lists_aln</span> <span class="o">=</span> <span class="n">sort_dots</span><span class="p">(</span><span class="n">aln_concat</span><span class="p">,</span> <span class="n">c_ds_aln</span><span class="o">.</span><span class="n">linked_array</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">c_ds_aln</span><span class="o">.</span><span class="n">linked_array</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>

            <span class="n">aln_peak_lists_raw</span><span class="p">,</span> <span class="n">aln_peak_lists_aln</span><span class="p">,</span> <span class="n">aln_kde_raw</span><span class="p">,</span> <span class="n">aln_kde_aln</span> <span class="o">=</span> <span class="n">alignment</span><span class="o">.</span><span class="n">munkres</span><span class="p">(</span><span class="n">peak_lists_raw</span><span class="p">,</span>
                                                                                                 <span class="n">peak_lists_aln</span><span class="p">,</span>
                                                                                                 <span class="n">c_ds_raw</span><span class="p">,</span>
                                                                                                 <span class="n">c_ds_aln</span><span class="p">,</span>
                                                                                                 <span class="n">c_ds_raw_intensity</span><span class="p">,</span>
                                                                                                 <span class="n">c_ds_aln_intensity</span><span class="p">,</span>
                                                                                                 <span class="n">segmentation_threshold</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>

            <span class="n">s_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span><span class="n">stat_params_paired_single</span><span class="p">(</span><span class="n">x_el</span><span class="p">,</span> <span class="n">y_el</span><span class="p">)</span> <span class="k">for</span> <span class="n">x_el</span><span class="p">,</span> <span class="n">y_el</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">aln_peak_lists_raw</span><span class="p">,</span> <span class="n">aln_peak_lists_aln</span><span class="p">)],</span>
                <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;object&#39;</span><span class="p">)</span>

            <span class="n">ret</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">(</span><span class="s1">&#39;show&#39;</span><span class="p">,</span> <span class="p">(((</span><span class="n">kde_x_raw</span><span class="p">,</span> <span class="n">kde_y_raw</span><span class="p">),</span> <span class="s1">&#39;raw&#39;</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="s1">&#39;kde&#39;</span><span class="p">),</span>
                        <span class="p">((</span><span class="n">kde_x_aln</span><span class="p">,</span> <span class="n">kde_y_aln</span><span class="p">),</span> <span class="s1">&#39;aln&#39;</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="s1">&#39;kde&#39;</span><span class="p">),</span>
                        <span class="p">(</span><span class="n">aln_kde_aln</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">kde_y_aln</span><span class="p">),</span><span class="s1">&#39;raw_peaks&#39;</span><span class="p">,</span><span class="s1">&#39;mult&#39;</span><span class="p">,</span><span class="s1">&#39;vln&#39;</span><span class="p">,</span><span class="s1">&#39;kde&#39;</span><span class="p">),</span>
                        <span class="p">(</span><span class="n">aln_kde_raw</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">kde_y_aln</span><span class="p">),</span> <span class="s1">&#39;raw_peaks&#39;</span><span class="p">,</span> <span class="s1">&#39;mult&#39;</span><span class="p">,</span> <span class="s1">&#39;vln&#39;</span><span class="p">,</span> <span class="s1">&#39;kde&#39;</span><span class="p">))),</span>
                <span class="c1">#(c_ds_raw, np.max(kde_y_raw), &#39;raw_peaks&#39;, &#39;red&#39;, &#39;vln&#39;, &#39;kde&#39;),</span>
                <span class="c1">#(c_ds_aln, np.max(kde_y_aln), &#39;aln_peaks&#39;, &#39;blue&#39;, &#39;vln&#39;, &#39;kde&#39;))),</span>
                <span class="c1">#(&#39;stats&#39;, (stat_params_unpaired(peak_lists_raw).T, stat_params_unpaired(peak_lists_aln).T)),</span>
                <span class="c1">#(&#39;stats_p&#39;, (stat_params_unpaired(aln_peak_lists_raw).T, stat_params_unpaired(aln_peak_lists_aln).T)),</span>
                <span class="p">(</span><span class="s1">&#39;stats&#39;</span><span class="p">,</span>
                 <span class="p">((</span><span class="n">stat_params_unpaired</span><span class="p">(</span><span class="n">peak_lists_raw</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="s1">&#39;raw&#39;</span><span class="p">),</span> <span class="p">(</span><span class="n">stat_params_unpaired</span><span class="p">(</span><span class="n">peak_lists_aln</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="s1">&#39;aln&#39;</span><span class="p">))),</span>
                <span class="p">(</span><span class="s1">&#39;stats_p&#39;</span><span class="p">,</span> <span class="p">((</span><span class="n">stat_params_unpaired</span><span class="p">(</span><span class="n">aln_peak_lists_raw</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="s1">&#39;raw&#39;</span><span class="p">),</span>
                             <span class="p">(</span><span class="n">stat_params_unpaired</span><span class="p">(</span><span class="n">aln_peak_lists_aln</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="s1">&#39;aln&#39;</span><span class="p">))),</span>
                <span class="p">(</span><span class="s1">&#39;stats_table&#39;</span><span class="p">,</span><span class="n">s_p</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
<span class="c1">#            self.error.emit(str(error))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span> <span class="c1">#temporary</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span></div>
</div>



<div class="viewcode-block" id="DatasetHeaders">
<a class="viewcode-back" href="../main.html#main.DatasetHeaders">[docs]</a>
<span class="k">class</span> <span class="nc">DatasetHeaders</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper to access HDF5 dataset attributes by name or index.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    attrs : Sequence[str]</span>
<span class="sd">        List of attribute names as provided by the HDF5 dataset.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    index : dict</span>
<span class="sd">        Mapping from attribute name to its integer index.</span>
<span class="sd">    name : list</span>
<span class="sd">        List of attribute names in positional order.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">attrs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build the name-to-index and index-to-name mappings.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        attrs : Sequence[str]</span>
<span class="sd">            Attribute names from the dataset.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">attrs</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">=</span><span class="n">index</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">index_value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert between names and indices for single values or lists.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        index_value : int, str, list[int], or list[str]</span>
<span class="sd">            Input specification to convert.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        int, str, or list</span>
<span class="sd">            The converted value(s): index for name input, name for index input.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index_value</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
            <span class="n">list_ind</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index_value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">int</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">ind</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">index_value</span><span class="p">):</span>
                    <span class="n">list_ind</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index_value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">str</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">ind</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">index_value</span><span class="p">):</span>
                    <span class="n">list_ind</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">list_ind</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index_value</span><span class="p">,</span><span class="nb">int</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="n">index_value</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index_value</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">index_value</span><span class="p">]</span></div>



<div class="viewcode-block" id="StreamRedirect">
<a class="viewcode-back" href="../main.html#main.StreamRedirect">[docs]</a>
<span class="k">class</span> <span class="nc">StreamRedirect</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Redirect-like object writing messages into a multiprocessing queue.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    q : multiprocessing.Queue</span>
<span class="sd">        Target queue where messages will be put.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the redirector.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        q : multiprocessing.Queue</span>
<span class="sd">            Target queue for messages.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q</span> <span class="o">=</span> <span class="n">q</span>

<div class="viewcode-block" id="StreamRedirect.write">
<a class="viewcode-back" href="../main.html#main.StreamRedirect.write">[docs]</a>
    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write a message to the queue if it&#39;s not empty or whitespace only.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        msg : str</span>
<span class="sd">            Message to forward.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>


<div class="viewcode-block" id="StreamRedirect.flush">
<a class="viewcode-back" href="../main.html#main.StreamRedirect.flush">[docs]</a>
    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Placeholder</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>
</div>



<div class="viewcode-block" id="ProcessManager">
<a class="viewcode-back" href="../main.html#main.ProcessManager">[docs]</a>
<span class="k">class</span> <span class="nc">ProcessManager</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Manage background processes and multiplex their stdout, stderr and results.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    signals : WorkerSignals</span>
<span class="sd">        Signals object to emit collected outputs to the main thread.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    output_q, error_q, return_q : multiprocessing.Queue</span>
<span class="sd">        Internal queues used to collect outputs from child processes.</span>
<span class="sd">    process_set : set[str]</span>
<span class="sd">        Names of currently running processes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signals</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create the manager and internal queues.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        signals : WorkerSignals</span>
<span class="sd">            Signals sink for emitting messages.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">signals</span> <span class="o">=</span> <span class="n">signals</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_q</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_q</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">return_q</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

<div class="viewcode-block" id="ProcessManager.run_process">
<a class="viewcode-back" href="../main.html#main.ProcessManager.run_process">[docs]</a>
    <span class="k">def</span> <span class="nf">run_process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">target_name</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Start a target function in a separate process.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        target : callable</span>
<span class="sd">            Function to execute in a child process.</span>
<span class="sd">        target_name : str</span>
<span class="sd">            Name used to track the process.</span>
<span class="sd">        args : list, optional</span>
<span class="sd">            Positional arguments for `target`.</span>
<span class="sd">        kwargs : dict, optional</span>
<span class="sd">            Keyword arguments for `target`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        multiprocessing.Process</span>
<span class="sd">            The started process instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_std_wrapper</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_q</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_q</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_q</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">target_name</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">p</span></div>


<div class="viewcode-block" id="ProcessManager.end_process">
<a class="viewcode-back" href="../main.html#main.ProcessManager.end_process">[docs]</a>
    <span class="k">def</span> <span class="nf">end_process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">process</span><span class="p">,</span> <span class="n">target_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Join the process if tracked by name and report join errors to `error_q`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        process : multiprocessing.Process</span>
<span class="sd">            Process to join.</span>
<span class="sd">        target_name : str</span>
<span class="sd">            Name that identifies the process in `process_set`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">target_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_set</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">process</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">error_q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error_q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;no process with name </span><span class="si">{}</span><span class="s1"> running&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">target_name</span><span class="p">))))</span></div>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_std_wrapper</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">out_q</span><span class="p">,</span> <span class="n">error_q</span><span class="p">,</span> <span class="n">ret_q</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(),</span> <span class="n">kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wrap a target callable to redirect stdio and return its result via queues.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        target : callable</span>
<span class="sd">            Function to execute.</span>
<span class="sd">        out_q, error_q, ret_q : multiprocessing.Queue</span>
<span class="sd">            Queues for stdout, stderr, and return payloads.</span>
<span class="sd">        args : tuple</span>
<span class="sd">            Positional arguments for `target`.</span>
<span class="sd">        kwargs : dict, optional</span>
<span class="sd">            Keyword arguments for `target`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">StreamRedirect</span><span class="p">(</span><span class="n">out_q</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">StreamRedirect</span><span class="p">(</span><span class="n">error_q</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">target</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">ret_q</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">target</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">result</span><span class="p">))</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error_q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__check_return</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Drain the return queue and emit results via `signals.result`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_q</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">func_name</span><span class="p">,</span> <span class="n">content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_q</span><span class="o">.</span><span class="n">get_nowait</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">Empty</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">error_q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__check_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Drain the error queue and emit messages via `signals.error`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_q</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_q</span><span class="o">.</span><span class="n">get_nowait</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
            <span class="k">except</span> <span class="n">Empty</span><span class="p">:</span>
                <span class="k">break</span>

    <span class="k">def</span> <span class="nf">__check_out</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Drain the stdout queue and emit messages via `signals.output`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_q</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_q</span><span class="o">.</span><span class="n">get_nowait</span><span class="p">()</span>
                <span class="c1"># print(msg)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">Empty</span><span class="p">:</span>
                <span class="k">break</span>

<div class="viewcode-block" id="ProcessManager.check_queues">
<a class="viewcode-back" href="../main.html#main.ProcessManager.check_queues">[docs]</a>
    <span class="k">def</span> <span class="nf">check_queues</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Poll all internal queues and forward their content via signals.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__check_return</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__check_error</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__check_out</span><span class="p">()</span></div>
</div>



<div class="viewcode-block" id="Dataset">
<a class="viewcode-back" href="../main.html#main.Dataset">[docs]</a>
<span class="k">class</span> <span class="nc">Dataset</span><span class="p">(</span><span class="n">LinkedList</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    LinkedList with an optional reference value attached.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    input_array : array_like</span>
<span class="sd">        Primary data.</span>
<span class="sd">    linked_array : array_like or None, optional</span>
<span class="sd">        Secondary linked data.</span>
<span class="sd">    reference : float or None, optional</span>
<span class="sd">        Reference m/z value associated with the dataset.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    reference : float or None</span>
<span class="sd">        The attached reference value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">input_array</span><span class="p">,</span> <span class="n">linked_array</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reference</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a Dataset and attach an optional reference value.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        input_array : array_like</span>
<span class="sd">            Primary data.</span>
<span class="sd">        linked_array : array_like or None, optional</span>
<span class="sd">            Secondary linked data.</span>
<span class="sd">        reference : float or None, optional</span>
<span class="sd">            Reference value to attach.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">input_array</span><span class="p">,</span> <span class="n">linked_array</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">reference</span> <span class="o">=</span> <span class="n">reference</span>
        <span class="k">return</span> <span class="n">obj</span>

    <span class="k">def</span> <span class="nf">__array_finalize__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Propagate `reference` and linked array when creating views.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        obj : ndarray or None</span>
<span class="sd">            Source object for the view.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__array_finalize__</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reference</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;reference&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assign items in the primary array and mirror to the linked array.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__setitem__</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>



<div class="viewcode-block" id="File">
<a class="viewcode-back" href="../main.html#main.File">[docs]</a>
<span class="k">class</span> <span class="nc">File</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Thin wrapper around an HDF5 file to read datasets and their headers.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    file_name : str or Path</span>
<span class="sd">        Path to the HDF5 file.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    real_path : Path</span>
<span class="sd">        Resolved path to the file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the file wrapper.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file_name : str or Path</span>
<span class="sd">            Path to the HDF5 file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">real_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>

<div class="viewcode-block" id="File.exist">
<a class="viewcode-back" href="../main.html#main.File.exist">[docs]</a>
    <span class="k">def</span> <span class="nf">exist</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check whether the file exists.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True if the file exists.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">real_path</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span></div>


<div class="viewcode-block" id="File.read">
<a class="viewcode-back" href="../main.html#main.File.read">[docs]</a>
    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read a dataset and its column headers from the HDF5 file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dataset : str</span>
<span class="sd">            HDF5 path to the dataset to read.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            A tuple ``(data, attr)`` where ``data`` is a NumPy array and</span>
<span class="sd">            ``attr`` is a list/array of column headers. Returns None on error.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        Exception</span>
<span class="sd">            If the number of headers does not match the number of columns.</span>
<span class="sd">        FileNotFoundError</span>
<span class="sd">            If the file does not exist.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">exist</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">FileNotFoundError</span>

            <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">real_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="n">dataset</span><span class="p">][:]</span>
                    <span class="n">attr</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;Column headers&quot;</span><span class="p">]</span>

                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span> <span class="o">!=</span> <span class="n">f</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span> <span class="o">==</span> <span class="n">f</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">T</span>
                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span> <span class="o">!=</span> <span class="n">f</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span> <span class="o">!=</span> <span class="n">f</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The number of columns does not match the number of headers&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">attr</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;File </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">real_path</span><span class="si">}</span><span class="s1"> not found&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Reading Error: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span></div>
</div>



<div class="viewcode-block" id="LogWidget">
<a class="viewcode-back" href="../main.html#main.LogWidget">[docs]</a>
<span class="k">class</span> <span class="nc">LogWidget</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QTextEdit</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read-only widget to display log and info messages.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the text widget.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        parent : QWidget, optional</span>
<span class="sd">            Parent widget.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QTabWidget</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setReadOnly</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__scrollDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Scroll to the bottom of the text area.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">scroll</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">verticalScrollBar</span><span class="p">()</span>
        <span class="n">end_text</span> <span class="o">=</span> <span class="n">scroll</span><span class="o">.</span><span class="n">maximum</span><span class="p">()</span>
        <span class="n">scroll</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">end_text</span><span class="p">)</span>

<div class="viewcode-block" id="LogWidget.updateText">
<a class="viewcode-back" href="../main.html#main.LogWidget.updateText">[docs]</a>
    <span class="k">def</span> <span class="nf">updateText</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Append a message and scroll to the end.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        msg : str</span>
<span class="sd">            Message to append.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__scrollDown</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="TreeWidget">
<a class="viewcode-back" href="../main.html#main.TreeWidget">[docs]</a>
<span class="k">class</span> <span class="nc">TreeWidget</span><span class="p">(</span><span class="n">QWidget</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Widget for browsing HDF5 groups and datasets as a tree.</span>

<span class="sd">    Signals</span>
<span class="sd">    -------</span>
<span class="sd">    path_signal : pyqtSignal(str)</span>
<span class="sd">        Emitted with the path of the double-clicked node.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">path_signal</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the tree widget and layout.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tree</span> <span class="o">=</span> <span class="n">QTreeWidget</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initUI</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__initUI</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Configure the internal QTreeWidget and layout.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Создаем layout и tree widget</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">setSelectionMode</span><span class="p">(</span><span class="n">QAbstractItemView</span><span class="o">.</span><span class="n">SingleSelection</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">itemDoubleClicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">expandAll</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">setHeaderLabels</span><span class="p">([</span><span class="s1">&#39;Name&#39;</span><span class="p">,</span><span class="s1">&#39;Type&#39;</span><span class="p">,</span><span class="s1">&#39;Shape&#39;</span><span class="p">,</span><span class="s1">&#39;DType&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">)</span>

<div class="viewcode-block" id="TreeWidget.populate_tree">
<a class="viewcode-back" href="../main.html#main.TreeWidget.populate_tree">[docs]</a>
    <span class="k">def</span> <span class="nf">populate_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Populate the tree with the hierarchy of an HDF5 file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path : str</span>
<span class="sd">            Path to an HDF5 file on disk.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">get_node</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Helper function to recursively print group and dataset info.&quot;&quot;&quot;</span>
            <span class="n">child</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">h5py</span><span class="o">.</span><span class="n">Group</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">child</span> <span class="o">=</span> <span class="n">QTreeWidgetItem</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
                    <span class="n">child</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                    <span class="n">child</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Group&#39;</span><span class="p">)</span>
                    <span class="n">child</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">QIcon</span><span class="p">(</span><span class="s2">&quot;folder_ico.png&quot;</span><span class="p">))</span>

                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">get_node</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">indent</span> <span class="o">+</span> <span class="s1">&#39;  &#39;</span><span class="p">,</span><span class="n">parent</span><span class="o">=</span><span class="n">child</span><span class="p">)</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">h5py</span><span class="o">.</span><span class="n">Dataset</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">child</span> <span class="o">=</span> <span class="n">QTreeWidgetItem</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
                    <span class="n">child</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                    <span class="n">child</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;Dataset&#39;</span><span class="p">)</span>
                    <span class="n">child</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
                    <span class="n">child</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>
                    <span class="n">child</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">QIcon</span><span class="p">(</span><span class="s2">&quot;ds_ico.png&quot;</span><span class="p">))</span>

        <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">root</span> <span class="o">=</span> <span class="n">QTreeWidgetItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="p">)</span>
            <span class="n">root</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;root&#39;</span><span class="p">)</span>
            <span class="n">get_node</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="n">parent</span><span class="o">=</span><span class="n">root</span><span class="p">)</span></div>


<div class="viewcode-block" id="TreeWidget.get_path">
<a class="viewcode-back" href="../main.html#main.TreeWidget.get_path">[docs]</a>
    <span class="k">def</span> <span class="nf">get_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the HDF5-like path of the selected node and emit it.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            The constructed path of the selected item.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">selection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">currentItem</span><span class="p">()</span>
        <span class="n">path</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">current</span> <span class="o">=</span> <span class="n">selection</span>
        <span class="k">while</span> <span class="n">current</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">current</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">current</span> <span class="o">=</span> <span class="n">current</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span>

        <span class="n">path_join</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;root//&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path_signal</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">path_join</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">path_join</span></div>


<div class="viewcode-block" id="TreeWidget.update_tree">
<a class="viewcode-back" href="../main.html#main.TreeWidget.update_tree">[docs]</a>
    <span class="k">def</span> <span class="nf">update_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clear and rebuild the tree from an HDF5 file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path : str</span>
<span class="sd">            Path to an HDF5 file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">populate_tree</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="MainWindow">
<a class="viewcode-back" href="../main.html#main.MainWindow">[docs]</a>
<span class="k">class</span> <span class="nc">MainWindow</span><span class="p">(</span><span class="n">QMainWindow</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main application window that hosts pages and coordinates background work.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the main window, tabs, and signal wiring.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s1">&#39;MZ alignment quality evaluation&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="mi">800</span><span class="p">,</span> <span class="mi">600</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tabs</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QTabWidget</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tabs</span><span class="o">.</span><span class="n">setTabPosition</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QTabWidget</span><span class="o">.</span><span class="n">North</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tabs</span><span class="o">.</span><span class="n">setMovable</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setCentralWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tabs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tabs</span><span class="o">.</span><span class="n">currentChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adjust_tab_sizes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">const</span> <span class="o">=</span> <span class="n">Const</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console_log</span> <span class="o">=</span> <span class="n">LogWidget</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">main</span> <span class="o">=</span> <span class="n">MainPage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;Main&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tabs</span><span class="o">.</span><span class="n">addTab</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">main</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">main</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span> <span class="o">=</span> <span class="n">GraphPage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;m/z&#39;</span><span class="p">],</span> <span class="n">y_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;dens&#39;</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;KDE&#39;</span><span class="p">,</span> <span class="n">title_plots</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;kde&#39;</span><span class="p">,))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tabs</span><span class="o">.</span><span class="n">addTab</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span> <span class="o">=</span> <span class="n">StatGraphPage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Statistics(Unpaired)&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tabs</span><span class="o">.</span><span class="n">addTab</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stats_p</span> <span class="o">=</span> <span class="n">StatGraphPage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Statistics(Paired)&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tabs</span><span class="o">.</span><span class="n">addTab</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stats_p</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats_p</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="n">TablePage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">title</span> <span class="o">=</span><span class="s1">&#39;Stat per peak&#39;</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tabs</span><span class="o">.</span><span class="n">addTab</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">set_title</span><span class="p">([</span><span class="s1">&#39;distance&#39;</span><span class="p">,</span><span class="s1">&#39;var(raw)&#39;</span><span class="p">,</span><span class="s1">&#39;var(aln)&#39;</span><span class="p">,</span><span class="s1">&#39;is normal distributed?&#39;</span><span class="p">,</span><span class="s1">&#39;neq_mean?&#39;</span><span class="p">,</span><span class="s1">&#39;neq_var?&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">signals</span> <span class="o">=</span> <span class="n">WorkerSignals</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manager</span> <span class="o">=</span> <span class="n">ProcessManager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signals</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="n">QTimer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">timeout</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">check_queues</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">console_log</span><span class="o">.</span><span class="n">updateText</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">console_log</span><span class="o">.</span><span class="n">updateText</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">console_log</span><span class="o">.</span><span class="n">updateText</span><span class="p">)</span>
        <span class="c1"># self.signals.result.connect(lambda ds: self.graph.add_plot_mul(ds))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redirect_outputs</span><span class="p">)</span>


<div class="viewcode-block" id="MainWindow.redirect_outputs">
<a class="viewcode-back" href="../main.html#main.MainWindow.redirect_outputs">[docs]</a>
    <span class="k">def</span> <span class="nf">redirect_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ret</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dispatch a composite results payload to the respective UI pages.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ret : Sequence[tuple]</span>
<span class="sd">            Iterable of (key, payload) pairs where key selects a handler.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aval_func</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;show&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">add_plot_mul</span><span class="p">,</span> <span class="s1">&#39;stats&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">add_plot_mul</span><span class="p">,</span> <span class="s1">&#39;stats_p&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats_p</span><span class="o">.</span><span class="n">add_plot_mul</span><span class="p">,</span><span class="s1">&#39;stats_table&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">add_data</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">ret</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">aval_func</span><span class="p">[</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]](</span><span class="n">output</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span></div>



<div class="viewcode-block" id="MainWindow.adjust_tab_sizes">
<a class="viewcode-back" href="../main.html#main.MainWindow.adjust_tab_sizes">[docs]</a>
    <span class="k">def</span> <span class="nf">adjust_tab_sizes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Resize tab widgets to fit the current tab area.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tab_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tabs</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tabs</span><span class="o">.</span><span class="n">count</span><span class="p">()):</span>
            <span class="n">tab</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tabs</span><span class="o">.</span><span class="n">widget</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">tab</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">tab_size</span><span class="p">)</span></div>


<div class="viewcode-block" id="MainWindow.resizeEvent">
<a class="viewcode-back" href="../main.html#main.MainWindow.resizeEvent">[docs]</a>
    <span class="k">def</span> <span class="nf">resizeEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle window resize events and adjust child sizes.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        event : QResizeEvent</span>
<span class="sd">            The resize event.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">resizeEvent</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adjust_tab_sizes</span><span class="p">()</span></div>



<div class="viewcode-block" id="MainWindow.start_calc">
<a class="viewcode-back" href="../main.html#main.MainWindow.start_calc">[docs]</a>
    <span class="k">def</span> <span class="nf">start_calc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">process_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Start a background calculation using the process manager.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        target : callable</span>
<span class="sd">            Function to run in background.</span>
<span class="sd">        process_name : str, optional</span>
<span class="sd">            Name for the process; defaults to ``target.__name__``.</span>
<span class="sd">        args : list, optional</span>
<span class="sd">            Positional arguments for the target.</span>
<span class="sd">        kwargs : dict, optional</span>
<span class="sd">            Keyword arguments for the target.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">process_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">process_name</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="vm">__name__</span>

        <span class="k">if</span> <span class="n">process_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">process_set</span><span class="p">:</span>
            <span class="k">pass</span>  <span class="c1">#already started</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">run_process</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">process_name</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="MainPage">
<a class="viewcode-back" href="../main.html#main.MainPage">[docs]</a>
<span class="k">class</span> <span class="nc">MainPage</span><span class="p">(</span><span class="n">QWidget</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main configuration page for selecting files, datasets and parameters.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    parent : QWidget</span>
<span class="sd">        Parent main window.</span>
<span class="sd">    title : str</span>
<span class="sd">        Page title.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">title</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build the configuration UI and wire controls.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span> <span class="o">=</span> <span class="n">QThread</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processing</span> <span class="o">=</span> <span class="n">WorkerSignals</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">title</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">main_layout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">main_layout</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">main_splitter</span> <span class="o">=</span> <span class="n">QSplitter</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">left_main_widget</span> <span class="o">=</span> <span class="n">QWidget</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">right_main_widget</span> <span class="o">=</span> <span class="n">QWidget</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">left_layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">right_layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">left_main_widget</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">left_layout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">right_main_widget</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">right_layout</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">main_splitter</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">left_main_widget</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_splitter</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">right_main_widget</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">main_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">main_splitter</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">left_splitter</span> <span class="o">=</span> <span class="n">QSplitter</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">Vertical</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">raw_tree</span> <span class="o">=</span> <span class="n">TreeWidget</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aln_tree</span> <span class="o">=</span> <span class="n">TreeWidget</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">left_splitter</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_tree</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">left_splitter</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aln_tree</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">left_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">left_splitter</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">splitter</span> <span class="o">=</span> <span class="n">QSplitter</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">const</span> <span class="o">=</span> <span class="n">Const</span>

        <span class="n">form_panel</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QWidget</span><span class="p">()</span>
        <span class="n">form_layout</span> <span class="o">=</span> <span class="n">QFormLayout</span><span class="p">()</span>
        <span class="n">form_panel</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">form_layout</span><span class="p">)</span>

        <span class="n">config_panel</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QWidget</span><span class="p">()</span>
        <span class="n">config_layout</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QVBoxLayout</span><span class="p">()</span>
        <span class="n">config_panel</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">config_layout</span><span class="p">)</span>
        <span class="c1">#self.setLayout(self.right_layout)</span>

        <span class="c1"># Raw</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raw_layout</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QHBoxLayout</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raw_filename</span> <span class="o">=</span> <span class="n">QLineEdit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raw_open_button</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="s2">&quot;Browse&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raw_open_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_filename</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raw_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_filename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raw_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_open_button</span><span class="p">)</span>
        <span class="c1"># aln</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aln_layout</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QHBoxLayout</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aln_filename</span> <span class="o">=</span> <span class="n">QLineEdit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aln_open_button</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="s2">&quot;Browse&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aln_open_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aln_filename</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aln_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aln_filename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aln_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aln_open_button</span><span class="p">)</span>
        <span class="c1"># ref and dev</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset_raw</span> <span class="o">=</span> <span class="n">QLineEdit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset_aln</span> <span class="o">=</span> <span class="n">QLineEdit</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ref_set</span> <span class="o">=</span> <span class="n">QLineEdit</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">raw_filename</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aln_filename</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dev_set</span> <span class="o">=</span> <span class="n">QLineEdit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bw_set</span> <span class="o">=</span> <span class="n">QLineEdit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_dots_set</span> <span class="o">=</span> <span class="n">QLineEdit</span><span class="p">()</span>

        <span class="n">form_layout</span><span class="o">.</span><span class="n">addRow</span><span class="p">(</span><span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;Raw data:&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_layout</span><span class="p">)</span>
        <span class="n">form_layout</span><span class="o">.</span><span class="n">addRow</span><span class="p">(</span><span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;Alignment data:&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">aln_layout</span><span class="p">)</span>
        <span class="n">form_layout</span><span class="o">.</span><span class="n">addRow</span><span class="p">(</span><span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;Dataset (raw):&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_raw</span><span class="p">)</span>
        <span class="n">form_layout</span><span class="o">.</span><span class="n">addRow</span><span class="p">(</span><span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;Dataset (aln):&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_aln</span><span class="p">)</span>
        <span class="n">form_layout</span><span class="o">.</span><span class="n">addRow</span><span class="p">(</span><span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;Reference point:&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_set</span><span class="p">)</span>
        <span class="n">form_layout</span><span class="o">.</span><span class="n">addRow</span><span class="p">(</span><span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;Acceptable deviation for msalign:&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">dev_set</span><span class="p">)</span>
        <span class="n">form_layout</span><span class="o">.</span><span class="n">addRow</span><span class="p">(</span><span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;Bandwidth:&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">bw_set</span><span class="p">)</span>
        <span class="n">form_layout</span><span class="o">.</span><span class="n">addRow</span><span class="p">(</span><span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;Number of dots:&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_dots_set</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">config_button</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="s2">&quot;Open config file&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_config</span><span class="p">())</span>
        <span class="c1"># self.load_config_button = QPushButton(&quot;Save configs&quot;)</span>
        <span class="c1"># self.load_config_button.clicked.connect(lambda: self.save_config())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calc_button</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="s2">&quot;Calculate&quot;</span><span class="p">)</span>
        <span class="n">config_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_button</span><span class="p">)</span>
        <span class="c1"># config_layout.addWidget(self.load_config_button)</span>
        <span class="n">config_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calc_button</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calc_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">signal</span><span class="p">())</span>
        <span class="c1"># self.calc_button.setEnabled(False)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pbar_widget</span> <span class="o">=</span> <span class="n">QWidget</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pbar_layout</span> <span class="o">=</span> <span class="n">QFormLayout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pbar_widget</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pbar</span> <span class="o">=</span> <span class="n">QProgressBar</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pbar_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="s2">&quot;Spectra processing:&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pbar_layout</span><span class="o">.</span><span class="n">addRow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pbar_label</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">pbar</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">splitter</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">form_panel</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">splitter</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">config_panel</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">right_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">splitter</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">right_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">console_log</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">raw_filename</span><span class="o">.</span><span class="n">textChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span> <span class="n">text</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_tree</span><span class="o">.</span><span class="n">update_tree</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aln_filename</span><span class="o">.</span><span class="n">textChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span> <span class="n">text</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">aln_tree</span><span class="o">.</span><span class="n">update_tree</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">raw_tree</span><span class="o">.</span><span class="n">path_signal</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span> <span class="n">path</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_raw</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aln_tree</span><span class="o">.</span><span class="n">path_signal</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span> <span class="n">path</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_aln</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">right_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pbar_widget</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pbar_widget</span><span class="o">.</span><span class="n">hide</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;last_config.yaml&quot;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">yaml_config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">Loader</span><span class="o">=</span><span class="n">yaml</span><span class="o">.</span><span class="n">FullLoader</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">raw_filename</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">yaml_config</span><span class="p">[</span><span class="s1">&#39;FILE_NAMES&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">aln_filename</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">yaml_config</span><span class="p">[</span><span class="s1">&#39;FILE_NAMES&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ref_set</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">yaml_config</span><span class="p">[</span><span class="s1">&#39;REF&#39;</span><span class="p">]))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dev_set</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">yaml_config</span><span class="p">[</span><span class="s1">&#39;DEV&#39;</span><span class="p">]))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dataset_raw</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">yaml_config</span><span class="p">[</span><span class="s1">&#39;DATASET_R&#39;</span><span class="p">]))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dataset_aln</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">yaml_config</span><span class="p">[</span><span class="s1">&#39;DATASET_A&#39;</span><span class="p">]))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bw_set</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">yaml_config</span><span class="p">[</span><span class="s1">&#39;BW&#39;</span><span class="p">]))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">n_dots_set</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">yaml_config</span><span class="p">[</span><span class="s1">&#39;NDOTS&#39;</span><span class="p">]))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
<div class="viewcode-block" id="MainPage.open_file">
<a class="viewcode-back" href="../main.html#main.MainPage.open_file">[docs]</a>
    <span class="k">def</span> <span class="nf">open_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw_filename</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Open a file dialog and set the selected path to the provided line edit.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        raw_filename : QLineEdit</span>
<span class="sd">            Line edit to receive the selected file path.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filename</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">QFileDialog</span><span class="o">.</span><span class="n">getOpenFileName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Open File&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;HDF (*.hdf *.hdf5 *.h5);;All Files (*)&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span> <span class="k">return</span>
        <span class="n">raw_filename</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span></div>


<div class="viewcode-block" id="MainPage.open_config">
<a class="viewcode-back" href="../main.html#main.MainPage.open_config">[docs]</a>
    <span class="k">def</span> <span class="nf">open_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load configuration from a YAML file and populate the UI fields.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filename</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">QFileDialog</span><span class="o">.</span><span class="n">getOpenFileName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Open File&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;yaml (*.yaml);;All Files (*)&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span> <span class="k">return</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">yaml_config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">Loader</span><span class="o">=</span><span class="n">yaml</span><span class="o">.</span><span class="n">FullLoader</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">raw_filename</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">yaml_config</span><span class="p">[</span><span class="s1">&#39;FILE_NAMES&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">aln_filename</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">yaml_config</span><span class="p">[</span><span class="s1">&#39;FILE_NAMES&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ref_set</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">yaml_config</span><span class="p">[</span><span class="s1">&#39;REF&#39;</span><span class="p">]))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dev_set</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">yaml_config</span><span class="p">[</span><span class="s1">&#39;DEV&#39;</span><span class="p">]))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dataset_raw</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">yaml_config</span><span class="p">[</span><span class="s1">&#39;DATASET_R&#39;</span><span class="p">]))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dataset_aln</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">yaml_config</span><span class="p">[</span><span class="s1">&#39;DATASET_A&#39;</span><span class="p">]))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bw_set</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">yaml_config</span><span class="p">[</span><span class="s1">&#39;BW&#39;</span><span class="p">]))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">n_dots_set</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">yaml_config</span><span class="p">[</span><span class="s1">&#39;NDOTS&#39;</span><span class="p">]))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span></div>


<div class="viewcode-block" id="MainPage.Pbar_set_ranges">
<a class="viewcode-back" href="../main.html#main.MainPage.Pbar_set_ranges">[docs]</a>
    <span class="k">def</span> <span class="nf">Pbar_set_ranges</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ranges</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the progress bar range and reset its value.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ranges : tuple[int, int]</span>
<span class="sd">            Minimum and maximum for the progress bar.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pbar</span><span class="o">.</span><span class="n">setRange</span><span class="p">(</span><span class="o">*</span><span class="n">ranges</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pbar</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>

<div class="viewcode-block" id="MainPage.Pbar_forwarder">
<a class="viewcode-back" href="../main.html#main.MainPage.Pbar_forwarder">[docs]</a>
    <span class="k">def</span> <span class="nf">Pbar_forwarder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update progress bar value.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        n : int</span>
<span class="sd">            New progress value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pbar</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">n</span><span class="p">)</span></div>

<div class="viewcode-block" id="MainPage.signal">
<a class="viewcode-back" href="../main.html#main.MainPage.signal">[docs]</a>
    <span class="k">def</span> <span class="nf">signal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate inputs, persist the last configuration, and start processing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pbar_widget</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pbar</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pbar_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s2">&quot;Spectra processing:&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_filename</span><span class="o">.</span><span class="n">text</span><span class="p">(),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">aln_filename</span><span class="o">.</span><span class="n">text</span><span class="p">(),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ref_set</span><span class="o">.</span><span class="n">text</span><span class="p">(),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dev_set</span><span class="o">.</span><span class="n">text</span><span class="p">(),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dataset_raw</span><span class="o">.</span><span class="n">text</span><span class="p">(),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dataset_aln</span><span class="o">.</span><span class="n">text</span><span class="p">(),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bw_set</span><span class="o">.</span><span class="n">text</span><span class="p">(),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">n_dots_set</span><span class="o">.</span><span class="n">text</span><span class="p">())</span>
            <span class="k">if</span> <span class="s1">&#39;&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Empty string&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>

                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;last_config.yaml&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
                    <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">({</span>
                        <span class="s1">&#39;FILE_NAMES&#39;</span><span class="p">:(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                        <span class="s1">&#39;REF&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                        <span class="s1">&#39;DEV&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
                        <span class="s1">&#39;DATASET_R&#39;</span><span class="p">:</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
                        <span class="s1">&#39;DATASET_A&#39;</span><span class="p">:</span><span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
                        <span class="s1">&#39;BW&#39;</span><span class="p">:</span><span class="nb">float</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">]),</span>
                        <span class="s1">&#39;NDOTS&#39;</span><span class="p">:</span><span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span>
                    <span class="p">},</span> <span class="n">outfile</span><span class="p">,</span> <span class="n">default_flow_style</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">Const</span><span class="o">.</span><span class="n">RAW</span><span class="p">,</span> <span class="n">Const</span><span class="o">.</span><span class="n">ALN</span><span class="p">,</span> <span class="n">Const</span><span class="o">.</span><span class="n">REF</span><span class="p">,</span> <span class="n">Const</span><span class="o">.</span><span class="n">DEV</span><span class="p">,</span> <span class="n">Const</span><span class="o">.</span><span class="n">DATASET_RAW</span><span class="p">,</span><span class="n">Const</span><span class="o">.</span><span class="n">DATASET_ALN</span><span class="p">,</span> <span class="n">Const</span><span class="o">.</span><span class="n">BW</span><span class="p">,</span> <span class="n">Const</span><span class="o">.</span><span class="n">N_DOTS</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">float</span><span class="p">(</span>
                <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span>
                <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="nb">float</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span>
            <span class="c1"># self.calc_button.setEnabled(True)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">processing</span><span class="o">.</span><span class="n">moveToThread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">started</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">processing</span><span class="o">.</span><span class="n">find_dots_process</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processing</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">quit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processing</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">processing</span><span class="o">.</span><span class="n">deleteLater</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">deleteLater</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processing</span><span class="o">.</span><span class="n">create_pbar</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Pbar_set_ranges</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processing</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Pbar_forwarder</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config_button</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calc_button</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processing</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">main_window</span><span class="o">.</span><span class="n">redirect_outputs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processing</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">main_window</span><span class="o">.</span><span class="n">console_log</span><span class="o">.</span><span class="n">updateText</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_button</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_button</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processing</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pbar_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s2">&quot;Process done&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pbar</span><span class="o">.</span><span class="n">hide</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processing</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pbar_label</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s2">&quot;Error occurred during processing&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processing</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_button</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processing</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_button</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processing</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pbar</span><span class="o">.</span><span class="n">hide</span><span class="p">()</span>
        <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="TablePage">
<a class="viewcode-back" href="../main.html#main.TablePage">[docs]</a>
<span class="k">class</span> <span class="nc">TablePage</span><span class="p">(</span><span class="n">QWidget</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Page containing a detailed statistics table and its row-wise average.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    parent : QWidget</span>
<span class="sd">        Parent widget.</span>
<span class="sd">    title : str, optional</span>
<span class="sd">        Page title.</span>
<span class="sd">    columns : int, optional</span>
<span class="sd">        Number of columns in the tables.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">parent</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;TablePage&#39;</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">title</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">splitter</span> <span class="o">=</span> <span class="n">QSplitter</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">Vertical</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="n">QTableWidget</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aver_table</span> <span class="o">=</span> <span class="n">QTableWidget</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">)</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">splitter</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">splitter</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aver_table</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">splitter</span><span class="o">.</span><span class="n">setSizes</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">()</span><span class="o">*</span><span class="mf">0.95</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">()</span><span class="o">*</span><span class="mf">0.05</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">splitter</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">setColumnCount</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aver_table</span><span class="o">.</span><span class="n">setColumnCount</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aver_table</span><span class="o">.</span><span class="n">setRowCount</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">aver_table</span><span class="o">.</span><span class="n">verticalHeader</span><span class="p">()</span><span class="o">.</span><span class="n">setDefaultSectionSize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aver_table</span><span class="o">.</span><span class="n">height</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">horizontalHeader</span><span class="p">()</span><span class="o">.</span><span class="n">setSectionResizeMode</span><span class="p">(</span><span class="n">QHeaderView</span><span class="o">.</span><span class="n">Stretch</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aver_table</span><span class="o">.</span><span class="n">horizontalHeader</span><span class="p">()</span><span class="o">.</span><span class="n">setSectionResizeMode</span><span class="p">(</span><span class="n">QHeaderView</span><span class="o">.</span><span class="n">Stretch</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">setSelectionBehavior</span><span class="p">(</span><span class="n">QAbstractItemView</span><span class="o">.</span><span class="n">SelectRows</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">setSelectionMode</span><span class="p">(</span><span class="n">QAbstractItemView</span><span class="o">.</span><span class="n">ExtendedSelection</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">itemSelectionChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">average_selected</span><span class="p">)</span>

<div class="viewcode-block" id="TablePage.set_title">
<a class="viewcode-back" href="../main.html#main.TablePage.set_title">[docs]</a>
    <span class="k">def</span> <span class="nf">set_title</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">title</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set column headers for both the main and average tables.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        title : list[str]</span>
<span class="sd">            Column titles.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">setHorizontalHeaderLabels</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aver_table</span><span class="o">.</span><span class="n">setHorizontalHeaderLabels</span><span class="p">(</span><span class="n">title</span><span class="p">)</span></div>

<div class="viewcode-block" id="TablePage.add_row">
<a class="viewcode-back" href="../main.html#main.TablePage.add_row">[docs]</a>
    <span class="k">def</span> <span class="nf">add_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Append a single row to the main table.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : Sequence</span>
<span class="sd">            Row values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">row_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">rowCount</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">insertRow</span><span class="p">(</span><span class="n">row_index</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">col</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">setItem</span><span class="p">(</span><span class="n">row_index</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">QTableWidgetItem</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span></div>


<div class="viewcode-block" id="TablePage.add_data">
<a class="viewcode-back" href="../main.html#main.TablePage.add_data">[docs]</a>
    <span class="k">def</span> <span class="nf">add_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Append multiple rows to the main table.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : Iterable[Sequence]</span>
<span class="sd">            Rows to append.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_row</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></div>


<div class="viewcode-block" id="TablePage.average_selected">
<a class="viewcode-back" href="../main.html#main.TablePage.average_selected">[docs]</a>
    <span class="k">def</span> <span class="nf">average_selected</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the column-wise average for selected rows and show it below.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">selected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">selectedItems</span><span class="p">()</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">el</span><span class="o">.</span><span class="n">text</span><span class="p">()</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">selected</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">col</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">aver_table</span><span class="o">.</span><span class="n">setItem</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">QTableWidgetItem</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span></div>
</div>



<div class="viewcode-block" id="GraphPage">
<a class="viewcode-back" href="../main.html#main.GraphPage">[docs]</a>
<span class="k">class</span> <span class="nc">GraphPage</span><span class="p">(</span><span class="n">QWidget</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Page with one or more plotting canvases built on pyqtgraph.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    parent : QWidget</span>
<span class="sd">        Parent widget.</span>
<span class="sd">    canvas_count : int, optional</span>
<span class="sd">        Number of plot canvases.</span>
<span class="sd">    title : str, optional</span>
<span class="sd">        Page title.</span>
<span class="sd">    title_plots : Sequence[str] or None, optional</span>
<span class="sd">        Titles for each canvas.</span>
<span class="sd">    x_labels, y_labels : Sequence[str] or None, optional</span>
<span class="sd">        Axis labels for each canvas.</span>
<span class="sd">    color : tuple, optional</span>
<span class="sd">        Default foreground color.</span>
<span class="sd">    bg_color : tuple, optional</span>
<span class="sd">        Background color.</span>
<span class="sd">    n_colors : int, optional</span>
<span class="sd">        Size of the categorical color palette.</span>
<span class="sd">    autoSize : bool, optional</span>
<span class="sd">        Whether to enable auto-ranging on the Y axis.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">canvas_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;PlotPage&#39;</span><span class="p">,</span> <span class="n">title_plots</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">x_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="n">bg_color</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span><span class="n">n_colors</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span><span class="n">autoSize</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">autoSize</span> <span class="o">=</span> <span class="n">autoSize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bg_color</span> <span class="o">=</span> <span class="n">bg_color</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">color</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fixed_colors</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">pg</span><span class="o">.</span><span class="n">mkColor</span><span class="p">(</span><span class="s1">&#39;blue&#39;</span><span class="p">),</span>  <span class="c1"># Синий</span>
            <span class="n">pg</span><span class="o">.</span><span class="n">mkColor</span><span class="p">(</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="n">x_labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">x_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">canvas_count</span>
        <span class="k">if</span> <span class="n">y_labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">y_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">canvas_count</span>
        <span class="k">if</span> <span class="n">title_plots</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">title_plots</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;plot</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">canvas_count</span><span class="p">)]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">canvas_adj</span> <span class="o">=</span> <span class="p">{</span><span class="n">title_plots</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">canvas_count</span><span class="p">)}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">title</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_spaces</span> <span class="o">=</span> <span class="p">[</span><span class="n">pg</span><span class="o">.</span><span class="n">PlotWidget</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">canvas_count</span><span class="p">)]</span>
        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pyqt_settings</span><span class="p">(</span><span class="n">pw_id</span><span class="p">)</span> <span class="k">for</span> <span class="n">pw_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_spaces</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">layout</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QVBoxLayout</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">canvas_count</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_spaces</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">showGrid</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_spaces</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">setTitle</span><span class="p">(</span><span class="n">title_plots</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_spaces</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_spaces</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">setLabel</span><span class="p">(</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">x_labels</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_spaces</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">setLabel</span><span class="p">(</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">y_labels</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">palette_colors</span> <span class="o">=</span>  <span class="p">[</span><span class="n">pg</span><span class="o">.</span><span class="n">intColor</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">hues</span><span class="o">=</span><span class="n">n_colors</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_colors</span><span class="p">)]</span>


<div class="viewcode-block" id="GraphPage.pyqt_settings">
<a class="viewcode-back" href="../main.html#main.GraphPage.pyqt_settings">[docs]</a>
    <span class="k">def</span> <span class="nf">pyqt_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">plot_widget</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply common pyqtgraph settings to a plot widget.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        plot_widget : pg.PlotWidget</span>
<span class="sd">            Target plot widget.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">plot_widget</span><span class="o">.</span><span class="n">addLegend</span><span class="p">(</span><span class="n">brush</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
        <span class="n">plot_widget</span><span class="o">.</span><span class="n">setMouseEnabled</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">vb</span> <span class="o">=</span> <span class="n">plot_widget</span><span class="o">.</span><span class="n">getViewBox</span><span class="p">()</span>

        <span class="c1"># Включить автомасштабирование по Y</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">autoSize</span><span class="p">:</span>
            <span class="n">vb</span><span class="o">.</span><span class="n">enableAutoRange</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
        <span class="c1"># Установить видимое автомасштабирование</span>
            <span class="n">vb</span><span class="o">.</span><span class="n">setAutoVisible</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="GraphPage.add_plot">
<a class="viewcode-back" href="../main.html#main.GraphPage.add_plot">[docs]</a>
    <span class="k">def</span> <span class="nf">add_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">plot_name</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">canvas_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot a 2D curve on the specified canvas.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : tuple(ndarray, ndarray)</span>
<span class="sd">            X and Y arrays.</span>
<span class="sd">        plot_name : str</span>
<span class="sd">            Name for the legend.</span>
<span class="sd">        color : str or tuple, optional</span>
<span class="sd">            Pen color.</span>
<span class="sd">        canvas_name : str or None, optional</span>
<span class="sd">            Canvas identifier; when None, use the first canvas.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">canvas_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plot_id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plot_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas_adj</span><span class="p">[</span><span class="n">canvas_name</span><span class="p">]</span>
        <span class="n">pen</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">mkPen</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_spaces</span><span class="p">[</span><span class="n">plot_id</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="n">plot_name</span><span class="p">,</span> <span class="n">pen</span><span class="o">=</span><span class="n">pen</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_spaces</span><span class="p">[</span><span class="n">plot_id</span><span class="p">]</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="s1">&#39;bottom&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="GraphPage.add_line">
<a class="viewcode-back" href="../main.html#main.GraphPage.add_line">[docs]</a>
    <span class="k">def</span> <span class="nf">add_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">y_max</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span><span class="n">canvas_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Draw vertical reference lines at X positions up to `y_max`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : array_like</span>
<span class="sd">            X positions of lines.</span>
<span class="sd">        y_max : float</span>
<span class="sd">            Maximum Y extent for the lines.</span>
<span class="sd">        color : str or tuple, optional</span>
<span class="sd">            Pen color or &#39;mult&#39; to use a color palette.</span>
<span class="sd">        canvas_name : str or None, optional</span>
<span class="sd">            Canvas identifier; when None, use the first canvas.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">canvas_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">plot_id</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plot_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas_adj</span><span class="p">[</span><span class="n">canvas_name</span><span class="p">]</span>

            <span class="n">y_min</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">data</span><span class="p">,</span>
                                 <span class="n">data</span><span class="p">,</span>
                                 <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)])</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">y_min</span><span class="p">),</span>
                                 <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">y_max</span><span class="p">),</span>
                                 <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)])</span>

            <span class="k">if</span> <span class="n">color</span> <span class="o">==</span> <span class="s1">&#39;mult&#39;</span><span class="p">:</span>

                <span class="n">length</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">length</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">palette_colors</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">palette_colors</span><span class="p">))]</span>

                <span class="n">x_s</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">idx</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]</span>
                <span class="n">y_s</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">idy</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">idy</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]</span>
                <span class="n">pens</span> <span class="o">=</span> <span class="p">[</span><span class="n">pg</span><span class="o">.</span><span class="n">mkPen</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">palette_colors</span><span class="p">[</span><span class="n">i</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">palette_colors</span><span class="p">)])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>

                <span class="k">for</span> <span class="n">figure_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">palette_colors</span><span class="p">)):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">plot_spaces</span><span class="p">[</span><span class="n">plot_id</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_s</span><span class="p">[</span><span class="n">figure_index</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span><span class="n">y_s</span><span class="p">[</span><span class="n">figure_index</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span><span class="n">pen</span> <span class="o">=</span> <span class="n">pens</span><span class="p">[</span><span class="n">figure_index</span><span class="p">])</span>
                <span class="c1">#self.plot_spaces[plot_id].plot(x,y,pen=pens)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
                <span class="n">pen</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">mkPen</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">DashLine</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plot_spaces</span><span class="p">[</span><span class="n">plot_id</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">pen</span><span class="o">=</span><span class="n">pen</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_spaces</span><span class="p">[</span><span class="n">plot_id</span><span class="p">]</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="s1">&#39;bottom&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span></div>

            <span class="c1"># self.plot_space.addItem(pg.InfiniteLine(pos=x,angle=90,pen=pen,movable=False))</span>

<div class="viewcode-block" id="GraphPage.add_dot">
<a class="viewcode-back" href="../main.html#main.GraphPage.add_dot">[docs]</a>
    <span class="k">def</span> <span class="nf">add_dot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">y_level</span><span class="p">,</span><span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span><span class="n">canvas_name</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="n">symbol</span> <span class="o">=</span> <span class="s1">&#39;o&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Scatter plot of points at a fixed Y level.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : array_like</span>
<span class="sd">            X positions for the markers.</span>
<span class="sd">        y_level : float</span>
<span class="sd">            Y coordinate for all markers.</span>
<span class="sd">        color : str or tuple, optional</span>
<span class="sd">            Color or &#39;mult&#39; to use a palette.</span>
<span class="sd">        canvas_name : str or None, optional</span>
<span class="sd">            Canvas identifier; when None, use the first canvas.</span>
<span class="sd">        symbol : str, optional</span>
<span class="sd">            Marker symbol.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">canvas_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plot_id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plot_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas_adj</span><span class="p">[</span><span class="n">canvas_name</span><span class="p">]</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y_level</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">color</span> <span class="o">==</span> <span class="s1">&#39;mult&#39;</span><span class="p">:</span>
            <span class="n">length</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span>

            <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">palette_colors</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">palette_colors</span><span class="p">))]</span>

            <span class="n">x_s</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]</span>
            <span class="n">y_s</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">idy</span><span class="p">)</span> <span class="k">for</span> <span class="n">idy</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]</span>

            <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">palette_colors</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">palette_colors</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">length</span><span class="p">)]</span>
            
            <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">palette_colors</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">figure_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">palette_colors</span><span class="p">)):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;!!!!!!!!!!!&#39;</span><span class="p">,</span><span class="n">figure_index</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">x_s</span><span class="p">[</span><span class="n">figure_index</span><span class="p">],</span><span class="n">y_s</span><span class="p">[</span><span class="n">figure_index</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plot_spaces</span><span class="p">[</span><span class="n">plot_id</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x_s</span><span class="p">[</span><span class="n">figure_index</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">y_s</span><span class="p">[</span><span class="n">figure_index</span><span class="p">],</span> <span class="n">symbol</span><span class="o">=</span><span class="n">symbol</span><span class="p">,</span><span class="n">symbol_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">symbolBrush</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">palette_colors</span><span class="p">[</span><span class="n">figure_index</span><span class="p">])</span>
                <span class="c1"># self.plot_spaces[plot_id].plot(x,y,pen=pens)</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">plot_spaces</span><span class="p">[</span><span class="n">plot_id</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span><span class="n">symbol</span><span class="o">=</span><span class="n">symbol</span><span class="p">,</span><span class="n">symbol_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">symbolBrush</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">plot_spaces</span><span class="p">[</span><span class="n">plot_id</span><span class="p">]</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="s1">&#39;bottom&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="GraphPage.add_plot_mul">
<a class="viewcode-back" href="../main.html#main.GraphPage.add_plot_mul">[docs]</a>
    <span class="k">def</span> <span class="nf">add_plot_mul</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Render multiple plot primitives given a compact descriptor list.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ds : Iterable[tuple]</span>
<span class="sd">            Each entry encodes a plot instruction; see producer for details.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># print(ds)</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">ds</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;p&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_plot</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;vln&#39;</span><span class="p">:</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">add_dot</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span></div>
</div>

                <span class="c1">#self.add_line(data[0], data[1], data[3], data[-1])</span>


<div class="viewcode-block" id="StatGraphPage">
<a class="viewcode-back" href="../main.html#main.StatGraphPage">[docs]</a>
<span class="k">class</span> <span class="nc">StatGraphPage</span><span class="p">(</span><span class="n">GraphPage</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Page for visualizing summary statistics distributions across datasets.</span>

<span class="sd">    Plots include standard deviation, dip test statistic/p-value, skewness,</span>
<span class="sd">    and kurtosis histograms for raw and aligned data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;StatPage&#39;</span><span class="p">,</span> <span class="n">x_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="n">bg_color</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">p_val</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">canvas_count</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">title_plots</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;std_dev&#39;</span><span class="p">,</span> <span class="s1">&#39;modality (dip test)&#39;</span><span class="p">,</span> <span class="s1">&#39;skewness&#39;</span><span class="p">,</span> <span class="s1">&#39;kurtosis&#39;</span><span class="p">),</span>
                         <span class="n">x_labels</span><span class="o">=</span><span class="n">x_labels</span><span class="p">,</span> <span class="n">y_labels</span><span class="o">=</span><span class="n">y_labels</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">bg_color</span><span class="o">=</span><span class="n">bg_color</span><span class="p">,</span><span class="n">autoSize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


        <span class="c1">#self.table_un = pg.TableWidget()  # сколько всего точек, медианное отклонение, число точек не мономодальных</span>
        <span class="c1">#self.table_list = {&#39;unpaired&#39;: self.table_un}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">p_val</span>
        <span class="c1">#self.table_data = np.zeros((3, 2))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">setStretch</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Виджет 1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">setStretch</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Виджет 2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">setStretch</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Виджет 3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">setStretch</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">table_layout</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QHBoxLayout</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table_layout</span><span class="p">)</span>
        <span class="c1">#self.table_layout.addWidget(self.table_un)</span>

<div class="viewcode-block" id="StatGraphPage.add_row">
<a class="viewcode-back" href="../main.html#main.StatGraphPage.add_row">[docs]</a>
    <span class="k">def</span> <span class="nf">add_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">table_name</span><span class="p">,</span><span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Append a row into an auxiliary table by name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">row_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_data</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span><span class="o">.</span><span class="n">rowCount</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table_data</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span><span class="o">.</span><span class="n">insertRow</span><span class="p">(</span><span class="n">row_index</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">col</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table_data</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span><span class="o">.</span><span class="n">setItem</span><span class="p">(</span><span class="n">row_index</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">QTableWidgetItem</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span></div>

<div class="viewcode-block" id="StatGraphPage.add_data">
<a class="viewcode-back" href="../main.html#main.StatGraphPage.add_data">[docs]</a>
    <span class="k">def</span> <span class="nf">add_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">table_name</span><span class="p">,</span><span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Append multiple rows into an auxiliary table by name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_row</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span><span class="n">line</span><span class="p">)</span></div>


<div class="viewcode-block" id="StatGraphPage.add_plot_mul">
<a class="viewcode-back" href="../main.html#main.StatGraphPage.add_plot_mul">[docs]</a>
    <span class="k">def</span> <span class="nf">add_plot_mul</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot multiple histogram-based statistics for provided datasets.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ds : Sequence</span>
<span class="sd">            Sequence of ``((data_arrays), label)`` pairs.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ds</span><span class="p">)):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">data_name</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">ds_color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixed_colors</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>

            <span class="c1">#self.table_data[0, n] = len(data[0])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">add_plot</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="sa">f</span><span class="s1">&#39;st dev </span><span class="si">{</span><span class="n">data_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ds_color</span><span class="p">,</span> <span class="s1">&#39;std_dev&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_plot</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="sa">f</span><span class="s1">&#39;dip </span><span class="si">{</span><span class="n">data_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ds_color</span><span class="p">,</span> <span class="s1">&#39;modality (dip test)&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_plot</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="sa">f</span><span class="s1">&#39;skew </span><span class="si">{</span><span class="n">data_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ds_color</span><span class="p">,</span> <span class="s1">&#39;skewness&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_plot</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="sa">f</span><span class="s1">&#39;kurt </span><span class="si">{</span><span class="n">data_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ds_color</span><span class="p">,</span> <span class="s1">&#39;kurtosis&#39;</span><span class="p">)</span></div>

            <span class="c1">#self.table_data[1, n] = np.where(data[2] &lt; self.p)[0].size</span>
            <span class="c1">#self.table_data[2, n] = np.median(data[0])</span>
        <span class="c1">#self.table_un.setData(self.table_data)</span>
        <span class="c1">#self.table_un.setHorizontalHeaderLabels([str(i) for i in range(len(ds))])</span>
        <span class="c1">#self.table_un.setVerticalHeaderLabels([&#39;total&#39;, &#39;is multimodal&#39;, &#39;median std dev&#39;])</span>

<div class="viewcode-block" id="StatGraphPage.add_plot">
<a class="viewcode-back" href="../main.html#main.StatGraphPage.add_plot">[docs]</a>
    <span class="k">def</span> <span class="nf">add_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">plot_name</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">canvas_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot a histogram-like step curve of the provided data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : array_like</span>
<span class="sd">            Data to histogram.</span>
<span class="sd">        plot_name : str</span>
<span class="sd">            Name for the legend.</span>
<span class="sd">        color : str or tuple</span>
<span class="sd">            Pen color.</span>
<span class="sd">        canvas_name : str or None, optional</span>
<span class="sd">            Canvas identifier.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">canvas_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plot_id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plot_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas_adj</span><span class="p">[</span><span class="n">canvas_name</span><span class="p">]</span>
        <span class="n">pen</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">mkPen</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
        <span class="n">no_nan</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">arr</span><span class="p">:</span> <span class="n">arr</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">arr</span><span class="p">)]</span>
        <span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">no_nan</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">bins</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">plot_spaces</span><span class="p">[</span><span class="n">plot_id</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">stepMode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">plot_name</span><span class="p">,</span> <span class="n">pen</span><span class="o">=</span><span class="n">pen</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_spaces</span><span class="p">[</span><span class="n">plot_id</span><span class="p">]</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="s1">&#39;bottom&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span></div>
</div>



<span class="sd">&#39;&#39;&#39;functions declaration&#39;&#39;&#39;</span>


<div class="viewcode-block" id="peak_picking">
<a class="viewcode-back" href="../main.html#main.peak_picking">[docs]</a>
<span class="k">def</span> <span class="nf">peak_picking</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">oversegmentation_filter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">peak_location</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Detect peaks in a KDE curve and return their centers and boundaries.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    X : ndarray</span>
<span class="sd">        Monotonic array of X coordinates (e.g., m/z grid).</span>
<span class="sd">    Y : ndarray</span>
<span class="sd">        Corresponding density/height values.</span>
<span class="sd">    oversegmentation_filter : float or None, optional</span>
<span class="sd">        Minimal allowed separation between adjacent peaks; when provided, peaks</span>
<span class="sd">        closer than this threshold are merged.</span>
<span class="sd">    peak_location : float, optional</span>
<span class="sd">        Fraction of the peak height to compute a barycentric center; used in</span>
<span class="sd">        boundary calculations as a threshold. Default is 1.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pk_x : ndarray</span>
<span class="sd">        Estimated peak centers (X positions). May contain NaNs if a region has</span>
<span class="sd">        no samples above the threshold.</span>
<span class="sd">    left : ndarray</span>
<span class="sd">        Left boundary (valley position) for each peak.</span>
<span class="sd">    right : ndarray</span>
<span class="sd">        Right boundary (valley position) for each peak.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">size</span>
    <span class="c1"># Robust valley finding</span>
    <span class="n">valley_dots</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">loc_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="n">valley_dots</span><span class="p">])</span>
    <span class="n">loc_min</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="kc">True</span><span class="p">,</span><span class="o">*</span><span class="p">(</span><span class="n">loc_min</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)]))</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(([</span><span class="o">*</span><span class="p">(</span><span class="n">loc_min</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span><span class="kc">True</span><span class="p">]))</span>
    <span class="n">left_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">valley_dots</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]])[</span><span class="n">loc_min</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">right_min</span> <span class="o">=</span> <span class="n">valley_dots</span><span class="p">[</span><span class="n">loc_min</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
    <span class="c1"># Compute max and min for every peak</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">left_min</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">val_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
    <span class="n">pos_peak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">[</span><span class="n">lm</span><span class="p">,</span> <span class="n">rm</span><span class="p">]</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">left_min</span><span class="p">,</span> <span class="n">right_min</span><span class="p">)):</span>
        <span class="n">pp</span> <span class="o">=</span> <span class="n">lm</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="n">lm</span><span class="p">:</span><span class="n">rm</span><span class="p">])</span>
        <span class="n">vm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="n">lm</span><span class="p">:</span><span class="n">rm</span><span class="p">])</span>
        <span class="n">val_max</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">vm</span>
        <span class="n">pos_peak</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">pp</span>

    <span class="c1"># Remove over-segmented peaks</span>
    <span class="k">if</span> <span class="n">oversegmentation_filter</span><span class="p">:</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">peak_threshold</span> <span class="o">=</span> <span class="n">val_max</span> <span class="o">*</span> <span class="n">peak_location</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span><span class="p">)</span>
            <span class="n">pk_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">left_min</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">[</span><span class="n">lm</span><span class="p">,</span> <span class="n">rm</span><span class="p">,</span> <span class="n">th</span><span class="p">]</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">left_min</span><span class="p">,</span> <span class="n">right_min</span><span class="p">,</span> <span class="n">peak_threshold</span><span class="p">)):</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[</span><span class="n">lm</span><span class="p">:</span><span class="n">rm</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">th</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">pk_x</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pk_x</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="n">lm</span><span class="p">:</span><span class="n">rm</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span> <span class="o">*</span> <span class="n">X</span><span class="p">[</span><span class="n">lm</span><span class="p">:</span><span class="n">rm</span><span class="p">][</span><span class="n">mask</span><span class="p">])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="n">lm</span><span class="p">:</span><span class="n">rm</span><span class="p">][</span><span class="n">mask</span><span class="p">])</span>
            <span class="n">dpk_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(([</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">pk_x</span><span class="p">),</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]))</span>

            <span class="n">j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">dpk_x</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">oversegmentation_filter</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dpk_x</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">dpk_x</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dpk_x</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">dpk_x</span><span class="p">[</span><span class="mi">2</span><span class="p">:]))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">j</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">left_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">left_min</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">right_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">right_min</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
            <span class="n">val_max</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">val_max</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">val_max</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">val_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">val_max</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">peak_threshold</span> <span class="o">=</span> <span class="n">val_max</span> <span class="o">*</span> <span class="n">peak_location</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span><span class="p">)</span>
        <span class="n">pk_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">left_min</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">[</span><span class="n">lm</span><span class="p">,</span> <span class="n">rm</span><span class="p">,</span> <span class="n">th</span><span class="p">]</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">left_min</span><span class="p">,</span> <span class="n">right_min</span><span class="p">,</span> <span class="n">peak_threshold</span><span class="p">)):</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[</span><span class="n">lm</span><span class="p">:</span><span class="n">rm</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">th</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">pk_x</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pk_x</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="n">lm</span><span class="p">:</span><span class="n">rm</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span> <span class="o">*</span> <span class="n">X</span><span class="p">[</span><span class="n">lm</span><span class="p">:</span><span class="n">rm</span><span class="p">][</span><span class="n">mask</span><span class="p">])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="n">lm</span><span class="p">:</span><span class="n">rm</span><span class="p">][</span><span class="n">mask</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">pk_x</span><span class="p">,</span> <span class="n">X</span><span class="p">[</span><span class="n">left_min</span><span class="p">],</span> <span class="n">X</span><span class="p">[</span><span class="n">right_min</span><span class="p">]</span></div>



<div class="viewcode-block" id="sort_dots">
<a class="viewcode-back" href="../main.html#main.sort_dots">[docs]</a>
<span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">sort_dots</span><span class="p">(</span><span class="n">ds</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">left</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">right</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Group values into bins defined by paired left/right boundaries.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ds : ndarray</span>
<span class="sd">        Values to be grouped.</span>
<span class="sd">    left : ndarray</span>
<span class="sd">        Left boundaries for each bin.</span>
<span class="sd">    right : ndarray</span>
<span class="sd">        Right boundaries for each bin.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list of ndarray</span>
<span class="sd">        For each interval [left[i], right[i]], the subset of `ds` within it.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">ds</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">left</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ds</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">right</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">ds</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mask</span><span class="o">.</span><span class="n">T</span><span class="p">]</span></div>



<div class="viewcode-block" id="get_long_and_short">
<a class="viewcode-back" href="../main.html#main.get_long_and_short">[docs]</a>
<span class="k">def</span> <span class="nf">get_long_and_short</span><span class="p">(</span><span class="n">arr_1</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">arr_2</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the longer and shorter of two arrays and a flag indicating order.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    arr_1, arr_2 : ndarray</span>
<span class="sd">        Arrays to compare by first-dimension length.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    long : ndarray</span>
<span class="sd">        The longer array.</span>
<span class="sd">    short : ndarray</span>
<span class="sd">        The shorter array.</span>
<span class="sd">    flag : bool</span>
<span class="sd">        True if ``arr_1`` is the longer array, else False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">size1</span><span class="p">,</span> <span class="n">size2</span> <span class="o">=</span> <span class="n">arr_1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">arr_2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">size1</span> <span class="o">&gt;</span> <span class="n">size2</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">arr_1</span><span class="p">,</span> <span class="n">arr_2</span><span class="p">,</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">arr_2</span><span class="p">,</span> <span class="n">arr_1</span><span class="p">,</span> <span class="kc">False</span></div>



<div class="viewcode-block" id="get_opt_strip">
<a class="viewcode-back" href="../main.html#main.get_opt_strip">[docs]</a>
<span class="k">def</span> <span class="nf">get_opt_strip</span><span class="p">(</span><span class="n">arr_long</span><span class="p">:</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">arr_short</span><span class="p">:</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">flag</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">Dataset</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Align two sequences by shifting the longer to minimize mean squared error.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    arr_long : Dataset</span>
<span class="sd">        Longer dataset.</span>
<span class="sd">    arr_short : Dataset</span>
<span class="sd">        Shorter dataset.</span>
<span class="sd">    flag : bool</span>
<span class="sd">        True if `arr_long` corresponds to the original first argument from</span>
<span class="sd">        ``get_long_and_short``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Dataset, Dataset</span>
<span class="sd">        Sliced/shifted versions with equal length, ordered to match the flag.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">arr_short</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">long_size</span> <span class="o">=</span> <span class="n">arr_long</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">max_shift</span> <span class="o">=</span> <span class="n">long_size</span> <span class="o">-</span> <span class="n">size</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">shift_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">max_shift</span><span class="p">)</span>
    <span class="n">score_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">max_shift</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">shift_array</span><span class="p">:</span>
        <span class="n">fit_score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">arr_short</span> <span class="o">-</span> <span class="n">arr_long</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">size</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">score_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit_score</span>
    <span class="n">opt_shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">score_array</span> <span class="o">==</span> <span class="n">score_array</span><span class="o">.</span><span class="n">min</span><span class="p">())[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">opt_long</span> <span class="o">=</span> <span class="n">arr_long</span><span class="p">[</span><span class="n">opt_shift</span><span class="p">:</span><span class="n">opt_shift</span> <span class="o">+</span> <span class="n">size</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">opt_long</span><span class="p">,</span> <span class="n">arr_short</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">arr_short</span><span class="p">,</span> <span class="n">opt_long</span></div>



<div class="viewcode-block" id="verify_datasets">
<a class="viewcode-back" href="../main.html#main.verify_datasets">[docs]</a>
<span class="k">def</span> <span class="nf">verify_datasets</span><span class="p">(</span><span class="n">data_1</span><span class="p">:</span> <span class="n">LinkedList</span><span class="p">,</span> <span class="n">data_2</span><span class="p">:</span> <span class="n">LinkedList</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">LinkedList</span><span class="p">,</span> <span class="n">LinkedList</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Verify and co-trim two sorted datasets so that element-wise differences are bounded.</span>

<span class="sd">    The function optionally removes one outlier (by index) and re-aligns to</span>
<span class="sd">    satisfy the threshold, returning two arrays of equal length.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data_1, data_2 : LinkedList</span>
<span class="sd">        Input datasets to verify.</span>
<span class="sd">    threshold : float or str, optional</span>
<span class="sd">        Maximum allowed absolute difference between paired values. If</span>
<span class="sd">        ``&#39;dist_based&#39;``, the mean difference is used as the threshold.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    LinkedList, LinkedList</span>
<span class="sd">        Verified (possibly trimmed) datasets of equal size.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">data_1</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="n">data_2</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
        <span class="n">data1_new</span><span class="p">,</span> <span class="n">data2_new</span> <span class="o">=</span> <span class="n">get_opt_strip</span><span class="p">(</span><span class="o">*</span><span class="n">get_long_and_short</span><span class="p">(</span><span class="n">data_1</span><span class="p">,</span> <span class="n">data_2</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data1_new</span> <span class="o">=</span> <span class="n">data_1</span>
        <span class="n">data2_new</span> <span class="o">=</span> <span class="n">data_2</span>

    <span class="n">dist_array</span> <span class="o">=</span> <span class="n">data1_new</span> <span class="o">-</span> <span class="n">data2_new</span>
    <span class="k">if</span> <span class="n">threshold</span> <span class="o">==</span> <span class="s1">&#39;dist_based&#39;</span><span class="p">:</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dist_array</span><span class="p">)</span>
    <span class="n">score_fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dist_array</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">score_fit</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">:</span>
        <span class="n">cut_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dist_array</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">)])</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">data1_new</span><span class="p">[</span><span class="n">cut_index</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">data2_new</span><span class="p">[</span><span class="n">cut_index</span><span class="p">]:</span>
            <span class="n">data1_new2</span> <span class="o">=</span> <span class="n">data1_new</span><span class="o">.</span><span class="n">sync_delete</span><span class="p">(</span><span class="n">cut_index</span><span class="p">)</span>
            <span class="n">data2_new2</span> <span class="o">=</span> <span class="n">data2_new</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data2_new2</span> <span class="o">=</span> <span class="n">data2_new</span><span class="o">.</span><span class="n">sync_delete</span><span class="p">(</span><span class="n">cut_index</span><span class="p">)</span>
            <span class="n">data1_new2</span> <span class="o">=</span> <span class="n">data1_new</span>
        <span class="k">return</span> <span class="n">get_opt_strip</span><span class="p">(</span><span class="o">*</span><span class="n">get_long_and_short</span><span class="p">(</span><span class="n">data1_new2</span><span class="p">,</span> <span class="n">data2_new2</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">data1_new</span><span class="p">,</span> <span class="n">data2_new</span></div>



<span class="n">_DATA_RAW</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">_DATA_ALN</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">_IDX</span> <span class="o">=</span> <span class="kc">None</span>          <span class="c1"># (mz_idx_raw, intensity_idx_raw, spectra_idx_raw, mz_idx_aln, intensity_idx_aln, spectra_idx_aln)</span>
<span class="n">_REF_DEV</span> <span class="o">=</span> <span class="kc">None</span>      <span class="c1"># (REF, DEV)</span>


<div class="viewcode-block" id="pool_initializer">
<a class="viewcode-back" href="../main.html#main.pool_initializer">[docs]</a>
<span class="k">def</span> <span class="nf">pool_initializer</span><span class="p">(</span><span class="n">data_raw</span><span class="p">,</span> <span class="n">data_aln</span><span class="p">,</span> <span class="n">idx_tuple</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="n">dev</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Pool initializer: store global references to datasets, indices, and params.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data_raw : ndarray</span>
<span class="sd">        Raw dataset array loaded from HDF5.</span>
<span class="sd">    data_aln : ndarray</span>
<span class="sd">        Aligned dataset array loaded from HDF5.</span>
<span class="sd">    idx_tuple : tuple[int, int, int, int, int, int]</span>
<span class="sd">        ``(mz_idx_raw, intensity_idx_raw, spectra_idx_raw, mz_idx_aln,</span>
<span class="sd">        intensity_idx_aln, spectra_idx_aln)`` indices into the datasets.</span>
<span class="sd">    ref : float</span>
<span class="sd">        Reference m/z value for ``find_ref``.</span>
<span class="sd">    dev : float</span>
<span class="sd">        Allowed deviation (±) around ``ref`` for reference search.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Stores the arguments into module-level globals (``_DATA_RAW``, ``_DATA_ALN``,</span>
<span class="sd">    ``_IDX``, ``_REF_DEV``) to avoid repeated pickling and argument passing to</span>
<span class="sd">    worker processes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">_DATA_RAW</span><span class="p">,</span> <span class="n">_DATA_ALN</span><span class="p">,</span> <span class="n">_IDX</span><span class="p">,</span> <span class="n">_REF_DEV</span>
    <span class="n">_DATA_RAW</span> <span class="o">=</span> <span class="n">data_raw</span>
    <span class="n">_DATA_ALN</span> <span class="o">=</span> <span class="n">data_aln</span>
    <span class="n">_IDX</span> <span class="o">=</span> <span class="n">idx_tuple</span>
    <span class="n">_REF_DEV</span> <span class="o">=</span> <span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span></div>



<div class="viewcode-block" id="process_spectrum">
<a class="viewcode-back" href="../main.html#main.process_spectrum">[docs]</a>
<span class="k">def</span> <span class="nf">process_spectrum</span><span class="p">(</span><span class="n">task</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process a single spectrum task and return datasets for raw and aligned.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    task : tuple[int, int, int, int, int]</span>
<span class="sd">        ``(spec_id, r0, r1, a0, a1)`` where ``[r0:r1]`` and ``[a0:a1]`` are</span>
<span class="sd">        inclusive slices for raw and aligned blocks belonging to ``spec_id``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        ``(spec_id, arr_raw, arr_aln)`` where ``arr_raw`` and ``arr_aln`` are</span>
<span class="sd">        NumPy arrays representing ``Dataset`` instances for the spectrum.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">spec_id</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">a0</span><span class="p">,</span> <span class="n">a1</span> <span class="o">=</span> <span class="n">task</span>
    <span class="n">mz_idx_raw</span><span class="p">,</span> <span class="n">intensity_idx_raw</span><span class="p">,</span> <span class="n">_s_idx_r</span><span class="p">,</span> <span class="n">mz_idx_aln</span><span class="p">,</span> <span class="n">intensity_idx_aln</span><span class="p">,</span> <span class="n">_s_idx_a</span> <span class="o">=</span> <span class="n">_IDX</span>
    <span class="n">REF</span><span class="p">,</span> <span class="n">DEV</span> <span class="o">=</span> <span class="n">_REF_DEV</span>

    <span class="c1"># извлечь и отсортировать по m/z</span>
    <span class="n">data_raw_unsorted</span> <span class="o">=</span> <span class="n">_DATA_RAW</span><span class="p">[[</span><span class="n">mz_idx_raw</span><span class="p">,</span> <span class="n">intensity_idx_raw</span><span class="p">],</span> <span class="n">r0</span><span class="p">:</span><span class="n">r1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">data_aln_unsorted</span> <span class="o">=</span> <span class="n">_DATA_ALN</span><span class="p">[[</span><span class="n">mz_idx_aln</span><span class="p">,</span> <span class="n">intensity_idx_aln</span><span class="p">],</span> <span class="n">a0</span><span class="p">:</span><span class="n">a1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

    <span class="n">order_raw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">data_raw_unsorted</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">order_aln</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">data_aln_unsorted</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">data_raw</span> <span class="o">=</span> <span class="n">data_raw_unsorted</span><span class="p">[:,</span> <span class="n">order_raw</span><span class="p">]</span>
    <span class="n">data_aln</span> <span class="o">=</span> <span class="n">data_aln_unsorted</span><span class="p">[:,</span> <span class="n">order_aln</span><span class="p">]</span>

    <span class="n">data_raw_mz</span><span class="p">,</span> <span class="n">data_aln_mz</span> <span class="o">=</span> <span class="n">data_raw</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data_aln</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">data_raw_int</span><span class="p">,</span> <span class="n">data_aln_int</span> <span class="o">=</span> <span class="n">data_raw</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">data_aln</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">data_raw_linked</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">data_raw_mz</span><span class="p">,</span> <span class="n">data_raw_int</span><span class="p">)</span>
    <span class="n">data_aln_linked</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">data_aln_mz</span><span class="p">,</span> <span class="n">data_aln_int</span><span class="p">)</span>

    <span class="n">checked_raw</span><span class="p">,</span> <span class="n">checked_aln</span> <span class="o">=</span> <span class="n">verify_datasets</span><span class="p">(</span><span class="n">data_raw_linked</span><span class="p">,</span> <span class="n">data_aln_linked</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">_</span><span class="p">,</span> <span class="n">ref_aln</span> <span class="o">=</span> <span class="n">find_ref</span><span class="p">(</span><span class="n">checked_aln</span><span class="p">,</span> <span class="n">REF</span><span class="p">,</span> <span class="n">DEV</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">ref_raw</span> <span class="o">=</span> <span class="n">find_ref</span><span class="p">(</span><span class="n">checked_raw</span><span class="p">,</span> <span class="n">REF</span><span class="p">,</span> <span class="n">DEV</span><span class="p">)</span>

    <span class="n">checked_raw</span><span class="o">.</span><span class="n">reference</span> <span class="o">=</span> <span class="n">ref_raw</span>
    <span class="n">checked_aln</span><span class="o">.</span><span class="n">reference</span> <span class="o">=</span> <span class="n">ref_aln</span>

    <span class="k">return</span> <span class="n">spec_id</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">checked_raw</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">checked_aln</span><span class="p">)</span></div>



<div class="viewcode-block" id="find_ref">
<a class="viewcode-back" href="../main.html#main.find_ref">[docs]</a>
<span class="k">def</span> <span class="nf">find_ref</span><span class="p">(</span><span class="n">dataset</span><span class="p">:</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">approx_mz</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">deviation</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Locate a reference peak near an approximate m/z within a deviation window.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dataset : Dataset</span>
<span class="sd">        Sorted m/z values (primary) with intensities as linked data.</span>
<span class="sd">    approx_mz : float</span>
<span class="sd">        Approximate m/z for the reference.</span>
<span class="sd">    deviation : float, optional</span>
<span class="sd">        Allowed deviation around `approx_mz` for candidate search.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        Pair ``(index, mz)`` of the selected reference peak.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">condition_1</span> <span class="o">=</span> <span class="n">approx_mz</span> <span class="o">-</span> <span class="n">deviation</span> <span class="o">&lt;=</span> <span class="n">dataset</span>
    <span class="n">condition_2</span> <span class="o">=</span> <span class="n">approx_mz</span> <span class="o">+</span> <span class="n">deviation</span> <span class="o">&gt;=</span> <span class="n">dataset</span>

    <span class="n">where_construct</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">condition_1</span> <span class="o">&amp;</span> <span class="n">condition_2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">where_construct</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
        <span class="n">ref_index</span> <span class="o">=</span> <span class="n">where_construct</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">linked_array</span><span class="p">[</span><span class="n">where_construct</span><span class="p">])]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ref_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dataset</span> <span class="o">-</span> <span class="n">approx_mz</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">ref_index</span><span class="p">,</span> <span class="n">dataset</span><span class="p">[</span><span class="n">ref_index</span><span class="p">]</span></div>



<div class="viewcode-block" id="read_dataset">
<a class="viewcode-back" href="../main.html#main.read_dataset">[docs]</a>
<span class="k">def</span> <span class="nf">read_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset_raw</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">attrs_raw</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">dataset_aln</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                 <span class="n">attrs_aln</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">REF</span><span class="p">,</span> <span class="n">DEV</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">processes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prepare per-spectrum datasets and emit progress for the UI, with optional</span>
<span class="sd">    sequential or parallel execution (multiprocessing.Pool).</span>

<span class="sd">    Overview</span>
<span class="sd">    --------</span>
<span class="sd">    - Resolve indices of required columns by headers (m/z and intensity).</span>
<span class="sd">    - Build contiguous segments for each spectrum id based on the spectra index.</span>
<span class="sd">    - Create tasks only for spectrum ids present in both raw and aligned inputs.</span>
<span class="sd">    - For each task: slice the subarrays, sort by m/z, verify alignment</span>
<span class="sd">      (``verify_datasets``), find a reference peak around ``REF`` within ``DEV``</span>
<span class="sd">      (``find_ref``), and store the result as a ``Dataset`` with a ``reference``.</span>
<span class="sd">    - Emit progress after each spectrum is processed.</span>

<span class="sd">    Modes</span>
<span class="sd">    -----</span>
<span class="sd">    - Sequential (``processes &lt;= 0``): runs in the main thread, preserving</span>
<span class="sd">      existing variable names and logic.</span>
<span class="sd">    - Parallel (``processes &gt; 0``): uses ``multiprocessing.Pool`` with an</span>
<span class="sd">      initializer (``pool_initializer``) and worker (``process_spectrum``).</span>
<span class="sd">      Tasks are processed in parallel; results may arrive unordered and are</span>
<span class="sd">      placed by ``spec_id``.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    self : WorkerSignals</span>
<span class="sd">        Object used to emit progress bar initialization and updates.</span>
<span class="sd">    dataset_raw, dataset_aln : ndarray</span>
<span class="sd">        Raw and aligned datasets read from HDF5.</span>
<span class="sd">    attrs_raw, attrs_aln : list of str</span>
<span class="sd">        Column headers for the respective datasets.</span>
<span class="sd">    REF : float</span>
<span class="sd">        Reference m/z seed.</span>
<span class="sd">    DEV : float</span>
<span class="sd">        Acceptable deviation (±) around ``REF`` for reference search.</span>
<span class="sd">    limit : int or None, optional</span>
<span class="sd">        Optional limit on the number of spectra to process (debugging).</span>
<span class="sd">    processes : int, optional</span>
<span class="sd">        Number of processes for ``multiprocessing.Pool``. ``&lt;= 0`` means</span>
<span class="sd">        sequential mode. Default is 0.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ndarray</span>
<span class="sd">        Array of shape ``(2, N)`` with ``dtype=Dataset``, where ``N`` is the</span>
<span class="sd">        number of processed spectra. ``dataset_list[0, spec_id]`` corresponds to</span>
<span class="sd">        the raw dataset; ``dataset_list[1, spec_id]`` to the aligned dataset.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - Only spectrum ids present in both raw and aligned datasets are processed.</span>
<span class="sd">    - The progress bar is initialized based on the number of tasks (common ids).</span>
<span class="sd">    - In parallel mode, result arrival order is not guaranteed.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">row_raw</span> <span class="o">=</span> <span class="n">DatasetHeaders</span><span class="p">(</span><span class="n">attrs_raw</span><span class="p">)</span>
    <span class="n">row_aln</span> <span class="o">=</span> <span class="n">DatasetHeaders</span><span class="p">(</span><span class="n">attrs_aln</span><span class="p">)</span>

    <span class="n">int_type</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="s2">&quot;mz&quot;</span> <span class="ow">in</span> <span class="n">attrs_raw</span><span class="p">:</span>
        <span class="n">mz_type</span> <span class="o">=</span> <span class="s2">&quot;mz&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mz_type</span> <span class="o">=</span> <span class="s2">&quot;peak&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;Intensity&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">attrs_raw</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Area&quot;</span><span class="p">,</span><span class="s2">&quot;SNR&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">attrs_raw</span><span class="p">:</span>
                <span class="n">int_type</span> <span class="o">=</span> <span class="n">column</span>
                <span class="k">break</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">int_type</span> <span class="o">=</span> <span class="s2">&quot;Intensity&quot;</span>

    <span class="k">if</span> <span class="n">int_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Intensity type not stated in attrs_raw, check file input&#39;</span><span class="p">)</span>

    <span class="n">index_row_raw</span> <span class="o">=</span> <span class="n">dataset_raw</span><span class="p">[</span><span class="n">row_raw</span><span class="p">(</span><span class="s2">&quot;spectra_ind&quot;</span><span class="p">)]</span>
    <span class="n">index_row_aln</span> <span class="o">=</span> <span class="n">dataset_aln</span><span class="p">[</span><span class="n">row_aln</span><span class="p">(</span><span class="s2">&quot;spectra_ind&quot;</span><span class="p">)]</span>

    <span class="n">start_index</span><span class="p">,</span> <span class="n">end_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">index_row_raw</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">index_row_raw</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">start_index</span> <span class="o">+</span> <span class="n">limit</span> <span class="o">&lt;=</span> <span class="n">end_index</span><span class="p">:</span>
            <span class="n">end_index</span> <span class="o">=</span> <span class="n">start_index</span> <span class="o">+</span> <span class="n">limit</span>

    <span class="n">set_num</span> <span class="o">=</span> <span class="n">end_index</span> <span class="o">-</span> <span class="n">start_index</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="n">dataset_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="n">set_num</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">Dataset</span><span class="p">)</span>

    <span class="c1"># предрасчёт сегментов по каждому индексу спектра</span>
    <span class="n">segments_raw</span> <span class="o">=</span> <span class="n">build_segments</span><span class="p">(</span><span class="n">index_row_raw</span><span class="p">)</span>
    <span class="n">segments_aln</span> <span class="o">=</span> <span class="n">build_segments</span><span class="p">(</span><span class="n">index_row_aln</span><span class="p">)</span>

    <span class="c1"># список задач только для тех индексов, которые есть и в raw, и в aln</span>
    <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">spec_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_index</span><span class="p">,</span> <span class="n">end_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">spec_id</span> <span class="ow">in</span> <span class="n">segments_raw</span> <span class="ow">and</span> <span class="n">spec_id</span> <span class="ow">in</span> <span class="n">segments_aln</span><span class="p">:</span>
            <span class="n">r0</span><span class="p">,</span> <span class="n">r1</span> <span class="o">=</span> <span class="n">segments_raw</span><span class="p">[</span><span class="n">spec_id</span><span class="p">]</span>
            <span class="n">a0</span><span class="p">,</span> <span class="n">a1</span> <span class="o">=</span> <span class="n">segments_aln</span><span class="p">[</span><span class="n">spec_id</span><span class="p">]</span>
            <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">spec_id</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">a0</span><span class="p">,</span> <span class="n">a1</span><span class="p">))</span>

    <span class="c1"># инициализация прогресса по числу задач</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">create_pbar</span><span class="o">.</span><span class="n">emit</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tasks</span><span class="p">)))</span>

    <span class="c1"># последовательная ветка — сохранить существующую логику имен/переменных</span>
    <span class="k">if</span> <span class="n">processes</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">spec_n</span><span class="p">,</span> <span class="p">(</span><span class="n">spec_id</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">a0</span><span class="p">,</span> <span class="n">a1</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tasks</span><span class="p">):</span>
            <span class="n">index_raw</span><span class="p">,</span> <span class="n">index_aln</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">index_row_raw</span> <span class="o">==</span> <span class="n">spec_id</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">index_row_aln</span> <span class="o">==</span> <span class="n">spec_id</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">data_raw_unsorted</span> <span class="o">=</span> <span class="n">dataset_raw</span><span class="p">[</span><span class="n">row_raw</span><span class="p">([</span><span class="n">mz_type</span><span class="p">,</span><span class="n">int_type</span><span class="p">]),</span> <span class="n">index_raw</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">index_raw</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">data_aln_unsorted</span> <span class="o">=</span> <span class="n">dataset_aln</span><span class="p">[</span><span class="n">row_aln</span><span class="p">([</span><span class="n">mz_type</span><span class="p">,</span><span class="n">int_type</span><span class="p">]),</span> <span class="n">index_aln</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">index_aln</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

            <span class="n">data_raw</span> <span class="o">=</span> <span class="n">data_raw_unsorted</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">data_raw_unsorted</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">data_aln</span> <span class="o">=</span> <span class="n">data_aln_unsorted</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">data_aln_unsorted</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span>

            <span class="n">data_raw_mz</span><span class="p">,</span> <span class="n">data_aln_mz</span> <span class="o">=</span> <span class="n">data_raw</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data_aln</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">data_raw_int</span><span class="p">,</span> <span class="n">data_aln_int</span> <span class="o">=</span> <span class="n">data_raw</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">data_aln</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

            <span class="n">data_raw_linked</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">data_raw_mz</span><span class="p">,</span> <span class="n">data_raw_int</span><span class="p">)</span>
            <span class="n">data_aln_linked</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">data_aln_mz</span><span class="p">,</span> <span class="n">data_aln_int</span><span class="p">)</span>

            <span class="n">checked_raw</span><span class="p">,</span> <span class="n">checked_aln</span> <span class="o">=</span> <span class="n">verify_datasets</span><span class="p">(</span><span class="n">data_raw_linked</span><span class="p">,</span> <span class="n">data_aln_linked</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

            <span class="n">_</span><span class="p">,</span> <span class="n">ref_aln</span> <span class="o">=</span> <span class="n">find_ref</span><span class="p">(</span><span class="n">checked_aln</span><span class="p">,</span> <span class="n">REF</span><span class="p">,</span> <span class="n">DEV</span><span class="p">)</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">ref_raw</span> <span class="o">=</span> <span class="n">find_ref</span><span class="p">(</span><span class="n">checked_raw</span><span class="p">,</span> <span class="n">REF</span><span class="p">,</span> <span class="n">DEV</span><span class="p">)</span>

            <span class="n">checked_raw</span><span class="o">.</span><span class="n">reference</span> <span class="o">=</span> <span class="n">ref_raw</span>
            <span class="n">checked_aln</span><span class="o">.</span><span class="n">reference</span> <span class="o">=</span> <span class="n">ref_aln</span>

            <span class="n">dataset_list</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">spec_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">checked_raw</span><span class="p">)</span>
            <span class="n">dataset_list</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">spec_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">checked_aln</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">spec_n</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dataset_list</span>

    <span class="c1"># параллельная ветка — Pool с минимальными изменениями</span>
    <span class="n">mz_idx_raw</span> <span class="o">=</span> <span class="n">row_raw</span><span class="p">(</span><span class="n">mz_type</span><span class="p">)</span>
    <span class="n">intensity_idx_raw</span> <span class="o">=</span> <span class="n">row_raw</span><span class="p">(</span><span class="n">int_type</span><span class="p">)</span>
    <span class="n">spectra_idx_raw</span> <span class="o">=</span> <span class="n">row_raw</span><span class="p">(</span><span class="s2">&quot;spectra_ind&quot;</span><span class="p">)</span>

    <span class="n">mz_idx_aln</span> <span class="o">=</span> <span class="n">row_aln</span><span class="p">(</span><span class="n">mz_type</span><span class="p">)</span>
    <span class="n">intensity_idx_aln</span> <span class="o">=</span> <span class="n">row_aln</span><span class="p">(</span><span class="n">int_type</span><span class="p">)</span>
    <span class="n">spectra_idx_aln</span> <span class="o">=</span> <span class="n">row_aln</span><span class="p">(</span><span class="s2">&quot;spectra_ind&quot;</span><span class="p">)</span>

    <span class="n">init_args</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">dataset_raw</span><span class="p">,</span>
        <span class="n">dataset_aln</span><span class="p">,</span>
        <span class="p">(</span><span class="n">mz_idx_raw</span><span class="p">,</span> <span class="n">intensity_idx_raw</span><span class="p">,</span> <span class="n">spectra_idx_raw</span><span class="p">,</span>
         <span class="n">mz_idx_aln</span><span class="p">,</span> <span class="n">intensity_idx_aln</span><span class="p">,</span> <span class="n">spectra_idx_aln</span><span class="p">),</span>
        <span class="n">REF</span><span class="p">,</span> <span class="n">DEV</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">with</span> <span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">processes</span><span class="p">,</span> <span class="n">initializer</span><span class="o">=</span><span class="n">pool_initializer</span><span class="p">,</span> <span class="n">initargs</span><span class="o">=</span><span class="n">init_args</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">spec_n</span><span class="p">,</span> <span class="p">(</span><span class="n">spec_id</span><span class="p">,</span> <span class="n">arr_raw</span><span class="p">,</span> <span class="n">arr_aln</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">imap_unordered</span><span class="p">(</span><span class="n">process_spectrum</span><span class="p">,</span> <span class="n">tasks</span><span class="p">)):</span>
            <span class="n">dataset_list</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">spec_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr_raw</span>
            <span class="n">dataset_list</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">spec_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr_aln</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">spec_n</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">dataset_list</span></div>



<div class="viewcode-block" id="build_segments">
<a class="viewcode-back" href="../main.html#main.build_segments">[docs]</a>
<span class="k">def</span> <span class="nf">build_segments</span><span class="p">(</span><span class="n">spectra_index_row</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build contiguous [start, end] slices for each value of ``spectra_ind``.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    spectra_index_row : ndarray</span>
<span class="sd">        1-D array of spectrum identifiers, typically the ``spectra_ind`` row</span>
<span class="sd">        from an HDF5 dataset.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict[int, tuple[int, int]]</span>
<span class="sd">        Mapping from spectrum id to an inclusive ``(start, end)`` slice within</span>
<span class="sd">        ``spectra_index_row`` covering its contiguous block.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">segments</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">spectra_index_row</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">segments</span>
    <span class="n">change_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">spectra_index_row</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">starts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(([</span><span class="mi">0</span><span class="p">],</span> <span class="n">change_pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">ends</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">change_pos</span><span class="p">,</span> <span class="p">[</span><span class="n">spectra_index_row</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]))</span>
    <span class="n">ids</span> <span class="o">=</span> <span class="n">spectra_index_row</span><span class="p">[</span><span class="n">ends</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">spec_id</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">starts</span><span class="p">,</span> <span class="n">ends</span><span class="p">,</span> <span class="n">ids</span><span class="p">):</span>
        <span class="n">segments</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">spec_id</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">segments</span></div>



<div class="viewcode-block" id="prepare_array">
<a class="viewcode-back" href="../main.html#main.prepare_array">[docs]</a>
<span class="k">def</span> <span class="nf">prepare_array</span><span class="p">(</span><span class="n">distances</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Concatenate per-peak distances and build a 2-row sorted view with indices.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    distances : ndarray or Sequence</span>
<span class="sd">        Pair or sequence of sequences to concatenate and index.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ndarray</span>
<span class="sd">        A 2 x K array with sorted values in row 0 and original indices in row 1.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">concatenated</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span> <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">distances</span><span class="p">])</span>
    <span class="n">indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">distances</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">sub_arr</span><span class="p">)</span> <span class="k">for</span> <span class="n">sub_arr</span> <span class="ow">in</span> <span class="n">distances</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
    <span class="n">pre_sorted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">concatenated</span><span class="p">,</span> <span class="n">indexes</span><span class="p">))</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">pre_sorted</span><span class="p">[:,</span> <span class="n">pre_sorted</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">argsort</span><span class="p">()]</span>
    <span class="k">return</span> <span class="n">result</span></div>



<div class="viewcode-block" id="concover">
<a class="viewcode-back" href="../main.html#main.concover">[docs]</a>
<span class="k">def</span> <span class="nf">concover</span><span class="p">(</span><span class="n">arr1</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span><span class="n">arr2</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compare two distributions using a rank-based variance (Conover-like) test.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    arr1, arr2 : ndarray</span>
<span class="sd">        Samples from two distributions.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        p-value for the test of equal scale/dispersion.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dev</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">data</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>

    <span class="n">dev1</span> <span class="o">=</span> <span class="n">dev</span><span class="p">(</span><span class="n">arr1</span><span class="p">)</span>
    <span class="n">dev2</span> <span class="o">=</span> <span class="n">dev</span><span class="p">(</span><span class="n">arr2</span><span class="p">)</span>

    <span class="n">all_devs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">dev1</span><span class="p">,</span> <span class="n">dev2</span><span class="p">))</span>
    <span class="n">ranks</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">rankdata</span><span class="p">(</span><span class="n">all_devs</span><span class="p">)</span>

    <span class="n">rank1</span> <span class="o">=</span> <span class="n">ranks</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">dev1</span><span class="p">)]</span>
    <span class="n">rank2</span> <span class="o">=</span> <span class="n">ranks</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">dev1</span><span class="p">):]</span>

    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dev1</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">dev2</span><span class="p">)</span>
    <span class="n">mean_rank</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>

    <span class="n">ss_between</span> <span class="o">=</span> <span class="p">(</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">dev1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rank1</span><span class="p">)</span><span class="o">-</span><span class="n">mean_rank</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">dev2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rank2</span><span class="p">)</span><span class="o">-</span><span class="n">mean_rank</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">ss_total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">ranks</span><span class="o">-</span><span class="n">mean_rank</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ss_between</span><span class="o">/</span><span class="n">ss_total</span>
    <span class="n">p_value</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">stats</span><span class="o">.</span><span class="n">chi2</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p_value</span></div>



<div class="viewcode-block" id="stat_params_paired_single">
<a class="viewcode-back" href="../main.html#main.stat_params_paired_single">[docs]</a>
<span class="k">def</span> <span class="nf">stat_params_paired_single</span><span class="p">(</span><span class="n">peak_raw</span><span class="p">,</span> <span class="n">peak_aln</span><span class="p">,</span> <span class="n">p_value</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute paired statistics between raw and aligned peak positions.</span>

<span class="sd">    For each matched peak, compute mean difference, variances, normality check,</span>
<span class="sd">    and hypothesis tests for means and variances.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    peak_raw, peak_aln : array_like</span>
<span class="sd">        Samples of raw and aligned values for a single peak.</span>
<span class="sd">    p_value : float, optional</span>
<span class="sd">        Significance level used in tests. Default is 0.05.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        ``(mean_diff, var_raw, var_aln, is_normal, neq_mean, neq_var)``</span>
<span class="sd">        where boolean flags are returned as floats (0.0/1.0).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># вычислить среднее и дисперсии, проверить нормальность, проверить гипотезы о значимости различия средних и дисперсий, возможно посчитать форму распределения</span>

    <span class="n">norm_var</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">data</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">),</span><span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">mean_r</span><span class="p">,</span> <span class="n">mean_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">peak_raw</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">peak_aln</span><span class="p">)</span>
    <span class="n">var_r</span><span class="p">,</span> <span class="n">var_a</span> <span class="o">=</span> <span class="n">norm_var</span><span class="p">(</span><span class="n">peak_raw</span><span class="p">),</span> <span class="n">norm_var</span><span class="p">(</span><span class="n">peak_aln</span><span class="p">)</span>

    <span class="n">check_normal_func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span><span class="p">,</span><span class="n">p</span><span class="p">:</span> <span class="n">stats</span><span class="o">.</span><span class="n">kstest</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="s1">&#39;norm&#39;</span><span class="p">,</span><span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">data</span><span class="p">)))[</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span><span class="n">p</span>
    <span class="n">check_normal</span> <span class="o">=</span> <span class="n">check_normal_func</span><span class="p">(</span><span class="n">peak_raw</span><span class="p">,</span><span class="n">p_value</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">check_normal_func</span><span class="p">(</span><span class="n">peak_aln</span><span class="p">,</span><span class="n">p_value</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">check_normal</span><span class="p">:</span>
        <span class="n">neq_var</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">levene</span><span class="p">(</span><span class="n">peak_raw</span><span class="p">,</span> <span class="n">peak_aln</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">p_value</span>
        <span class="n">neq_mean</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">ttest_ind</span><span class="p">(</span><span class="n">peak_raw</span><span class="p">,</span> <span class="n">peak_aln</span><span class="p">,</span><span class="n">nan_policy</span><span class="o">=</span><span class="s1">&#39;omit&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">p_value</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">neq_mean</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">mannwhitneyu</span><span class="p">(</span><span class="n">peak_raw</span><span class="p">,</span> <span class="n">peak_aln</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">p_value</span>
        <span class="n">neq_var</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">ansari</span><span class="p">(</span><span class="n">peak_raw</span><span class="p">,</span> <span class="n">peak_aln</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">p_value</span>

    <span class="k">return</span> <span class="n">mean_r</span> <span class="o">-</span> <span class="n">mean_a</span><span class="p">,</span> <span class="n">var_r</span><span class="p">,</span> <span class="n">var_a</span><span class="p">,</span><span class="nb">float</span><span class="p">(</span><span class="n">check_normal</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">neq_mean</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">neq_var</span><span class="p">)</span></div>



<div class="viewcode-block" id="stat_params_unpaired">
<a class="viewcode-back" href="../main.html#main.stat_params_unpaired">[docs]</a>
<span class="k">def</span> <span class="nf">stat_params_unpaired</span><span class="p">(</span><span class="n">ds</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute unpaired per-group statistics for a list of arrays.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ds : Sequence[array_like]</span>
<span class="sd">        Sequence of samples (e.g., peak positions per bin).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ndarray</span>
<span class="sd">        Array with columns: variance, dip statistic, dip p-value, skewness,</span>
<span class="sd">        kurtosis for each group.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">dot</span><span class="p">),</span> <span class="o">*</span><span class="n">diptest</span><span class="p">(</span><span class="n">dot</span><span class="p">),</span> <span class="n">stats</span><span class="o">.</span><span class="n">skew</span><span class="p">(</span><span class="n">dot</span><span class="p">),</span> <span class="n">stats</span><span class="o">.</span><span class="n">kurtosis</span><span class="p">(</span><span class="n">dot</span><span class="p">)]</span> <span class="k">for</span> <span class="n">dot</span> <span class="ow">in</span> <span class="n">ds</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">res</span></div>



<div class="viewcode-block" id="moving_average">
<a class="viewcode-back" href="../main.html#main.moving_average">[docs]</a>
<span class="k">def</span> <span class="nf">moving_average</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the simple moving average over a 1D array.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    a : ndarray</span>
<span class="sd">        Input array.</span>
<span class="sd">    n : int, optional</span>
<span class="sd">        Window size. Default is 2.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ndarray</span>
<span class="sd">        Averaged array of length ``len(a) - n + 1``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">ret</span><span class="p">[</span><span class="n">n</span><span class="p">:]</span> <span class="o">=</span> <span class="n">ret</span><span class="p">[</span><span class="n">n</span><span class="p">:]</span> <span class="o">-</span> <span class="n">ret</span><span class="p">[:</span><span class="o">-</span><span class="n">n</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">ret</span><span class="p">[</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">/</span> <span class="n">n</span></div>



<div class="viewcode-block" id="out_criteria">
<a class="viewcode-back" href="../main.html#main.out_criteria">[docs]</a>
<span class="k">def</span> <span class="nf">out_criteria</span><span class="p">(</span><span class="n">mz</span><span class="p">,</span> <span class="n">intensity</span><span class="p">,</span> <span class="n">int_threshold</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span> <span class="n">max_diff</span> <span class="o">=</span> <span class="mf">0.4</span><span class="p">,</span> <span class="n">width_eps</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">):</span><span class="c1"># TODO: add documentation (see TG for descr.)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Identify outlier peak intervals based on intensity and width heuristics.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mz : Dataset or LinkedList</span>
<span class="sd">        Peak centers with linked boundaries in `linked_array`.</span>
<span class="sd">    intensity : ndarray</span>
<span class="sd">        Intensities corresponding to `mz` centers.</span>
<span class="sd">    int_threshold : float, optional</span>
<span class="sd">        Fraction of the maximum intensity below which points are flagged.</span>
<span class="sd">    max_diff : float, optional</span>
<span class="sd">        Maximum relative change between consecutive intensities (as |a/b - 1|).</span>
<span class="sd">    width_eps : float, optional</span>
<span class="sd">        Threshold on normalized width ratio used for flagging.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ndarray</span>
<span class="sd">        Indices of points considered outliers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">min_int</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">intensity</span><span class="p">)</span> <span class="o">*</span> <span class="n">int_threshold</span>
    <span class="n">first_or</span> <span class="o">=</span> <span class="n">intensity</span> <span class="o">&lt;</span> <span class="n">min_int</span>
    <span class="n">int_criteria</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">intensity</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">intensity</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">max_diff</span>

    <span class="n">width_criteria</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">mz</span><span class="p">)</span> <span class="o">/</span> <span class="n">moving_average</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">mz</span><span class="o">.</span><span class="n">linked_array</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span> <span class="o">&lt;=</span> <span class="n">width_eps</span>
    <span class="n">second_or</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">mz</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">second_or</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">int_criteria</span><span class="p">,</span> <span class="n">width_criteria</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">first_or</span><span class="p">,</span> <span class="n">second_or</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span></div>



<div class="viewcode-block" id="criteria_apply">
<a class="viewcode-back" href="../main.html#main.criteria_apply">[docs]</a>
<span class="k">def</span> <span class="nf">criteria_apply</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">intensity</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Merge narrow neighboring intervals and drop flagged indices.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    arr : LinkedList</span>
<span class="sd">        Peak centers with linked left/right boundaries.</span>
<span class="sd">    intensity : ndarray</span>
<span class="sd">        Intensities used to evaluate the criteria.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    LinkedList</span>
<span class="sd">        Filtered peaks with adjusted boundaries.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">arr_out</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
    <span class="n">indexes</span> <span class="o">=</span> <span class="n">out_criteria</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">intensity</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">indexes</span><span class="p">:</span>
        <span class="n">arr_out</span><span class="o">.</span><span class="n">linked_array</span><span class="p">[</span><span class="n">index</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">arr</span><span class="o">.</span><span class="n">linked_array</span><span class="p">[</span><span class="n">index</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">arr</span><span class="o">.</span><span class="n">linked_array</span><span class="p">[</span><span class="n">index</span><span class="p">,</span><span class="mi">1</span><span class="p">]])</span>
    <span class="k">return</span> <span class="n">arr_out</span><span class="o">.</span><span class="n">sync_delete</span><span class="p">(</span><span class="n">indexes</span><span class="p">)</span></div>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>

    <span class="n">app</span> <span class="o">=</span> <span class="n">QApplication</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span>
    <span class="n">app_icon</span> <span class="o">=</span> <span class="n">QIcon</span><span class="p">(</span><span class="s1">&#39;main_ico.png&#39;</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">setWindowIcon</span><span class="p">(</span><span class="n">app_icon</span><span class="p">)</span>
    <span class="n">main_window</span> <span class="o">=</span> <span class="n">MainWindow</span><span class="p">()</span>
    <span class="n">main_window</span><span class="o">.</span><span class="n">showMaximized</span><span class="p">()</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">exec_</span><span class="p">())</span>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Basikhin Igor, Andrey Kuzin.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>